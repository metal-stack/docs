<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Kubernetes Integration · metal-stack</title><meta name="title" content="Kubernetes Integration · metal-stack"/><meta property="og:title" content="Kubernetes Integration · metal-stack"/><meta property="twitter:title" content="Kubernetes Integration · metal-stack"/><meta name="description" content="Documentation for metal-stack."/><meta property="og:description" content="Documentation for metal-stack."/><meta property="twitter:description" content="Documentation for metal-stack."/><meta property="og:url" content="https://docs.metal-stack.io/overview/kubernetes/"/><meta property="twitter:url" content="https://docs.metal-stack.io/overview/kubernetes/"/><link rel="canonical" href="https://docs.metal-stack.io/overview/kubernetes/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../assets/youtube.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="metal-stack logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">metal-stack</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><span class="tocitem">Overview</span><ul><li><a class="tocitem" href="../architecture/">Architecture</a></li><li><a class="tocitem" href="../networking/">Networking</a></li><li><a class="tocitem" href="../hardware/">Hardware Support</a></li><li><a class="tocitem" href="../os/">Operating Systems</a></li><li class="is-active"><a class="tocitem" href>Kubernetes Integration</a><ul class="internal"><li><a class="tocitem" href="#metal-ccm"><span>metal-ccm</span></a></li><li><a class="tocitem" href="#firewall-controller"><span>firewall-controller</span></a></li><li><a class="tocitem" href="#Gardener-components"><span>Gardener components</span></a></li><li><a class="tocitem" href="#Gardener-with-metal-stack"><span>Gardener with metal-stack</span></a></li></ul></li><li><a class="tocitem" href="../isolated-kubernetes/">Isolated Kubernetes</a></li><li><a class="tocitem" href="../gpu-support/">GPU Support</a></li><li><a class="tocitem" href="../storage/">Storage</a></li><li><a class="tocitem" href="../comparison/">Comparison</a></li></ul></li><li><a class="tocitem" href="../../quickstart/">Quickstart</a></li><li><span class="tocitem">Installation &amp; Administration</span><ul><li><a class="tocitem" href="../../installation/deployment/">Installation</a></li><li><a class="tocitem" href="../../installation/updates/">Releases and Updates</a></li><li><a class="tocitem" href="../../installation/monitoring/">Monitoring</a></li><li><a class="tocitem" href="../../installation/troubleshoot/">Troubleshoot</a></li></ul></li><li><span class="tocitem">User Guides</span><ul><li><a class="tocitem" href="../../external/mini-lab/README/">mini-lab</a></li><li><a class="tocitem" href="../../external/metalctl/README/">metalctl</a></li><li><a class="tocitem" href="../../external/csi-driver-lvm/README/">csi-driver-lvm</a></li><li><a class="tocitem" href="../../external/firewall-controller/README/">firewall-controller</a></li></ul></li><li><a class="tocitem" href="../../apidocs/apidocs/">API Documentation</a></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../../development/client_libraries/">Client Libraries</a></li><li><a class="tocitem" href="../../development/roadmap/">Roadmap</a></li><li><a class="tocitem" href="../../development/proposals/">Enhancement Proposals</a></li><li><a class="tocitem" href="../../development/contributing/">Contributing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Overview</a></li><li class="is-active"><a href>Kubernetes Integration</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Kubernetes Integration</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/metal-stack/docs.git" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="github.com/metal-stack/docs.git" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Kubernetes-Integration"><a class="docs-heading-anchor" href="#Kubernetes-Integration">Kubernetes Integration</a><a id="Kubernetes-Integration-1"></a><a class="docs-heading-anchor-permalink" href="#Kubernetes-Integration" title="Permalink"></a></h1><p>With the help of the <a href="https://gardener.cloud/">Gardener</a> project, metal-stack can be used for spinning up Kubernetes clusters quickly and reliably on bare metal machines.</p><p>To make this happen, we implemented a couple of components, which are described here.</p><ul><li><a href="#Kubernetes-Integration">Kubernetes Integration</a></li><li class="no-marker"><ul><li><a href="#metal-ccm">metal-ccm</a></li><li><a href="#firewall-controller">firewall-controller</a></li><li><a href="#Gardener-components">Gardener components</a></li><li class="no-marker"><ul><li><a href="#gardener-extension-provider-metal">gardener-extension-provider-metal</a></li><li><a href="#os-metal-extension">os-metal-extension</a></li><li><a href="#machine-controller-manager-provider-metal">machine-controller-manager-provider-metal</a></li></ul></li><li><a href="#Gardener-with-metal-stack">Gardener with metal-stack</a></li><li class="no-marker"><ul><li><a href="#Introduction-into-Gardener">Introduction into Gardener</a></li><li><a href="#Gardener-glossary">Gardener glossary</a></li><li><a href="#Initial-Cluster-Setup">Initial Cluster Setup</a></li><li><a href="#metal-stack-Setup">metal-stack Setup</a></li><li><a href="#Garden-Cluster-Setup">Garden Cluster Setup</a></li></ul></li></ul></li></ul><h2 id="metal-ccm"><a class="docs-heading-anchor" href="#metal-ccm">metal-ccm</a><a id="metal-ccm-1"></a><a class="docs-heading-anchor-permalink" href="#metal-ccm" title="Permalink"></a></h2><p>CCM stands for <a href="https://kubernetes.io/docs/concepts/architecture/cloud-controller/">cloud-controller-manager</a> and is the bridge between Kubernetes and a cloud-provider.</p><p>We implemented the <a href="https://github.com/kubernetes/cloud-provider/blob/master/cloud.go">cloud provider interface</a> in the <a href="https://github.com/metal-stack/metal-ccm">metal-ccm</a> repository. With the help of the cloud-controller-controller we provide metal-stack-specific properties for Kubernetes clusters, e.g. load balancer configuration through MetalLB or node properties.</p><h2 id="firewall-controller"><a class="docs-heading-anchor" href="#firewall-controller">firewall-controller</a><a id="firewall-controller-1"></a><a class="docs-heading-anchor-permalink" href="#firewall-controller" title="Permalink"></a></h2><p>To make the firewalls created with metal-stack easily configurable through Kubernetes resources, we add our <a href="https://github.com/metal-stack/firewall-controller">firewall-controller</a> to the firewall image. The controller watches special CRDs, enabling users to manage:</p><ul><li>nftables rules</li><li>Intrusion-detection with <a href="https://suricata.io/">suricata</a></li><li>network metric collection</li></ul><p>Please check out the <a href="../../external/firewall-controller/README/">guide</a> on how to use it.</p><h2 id="Gardener-components"><a class="docs-heading-anchor" href="#Gardener-components">Gardener components</a><a id="Gardener-components-1"></a><a class="docs-heading-anchor-permalink" href="#Gardener-components" title="Permalink"></a></h2><p>There are some Gardener resources that need be reconciled when you act as a cloud provider for the Gardener. This section briefly describes the controllers implemented for deploying Kubernetes clusters through Gardener.</p><p>If you want to learn how to deploy metal-stack with Gardener, please check out the <a href="../../installation/deployment/#Gardener-with-metal-stack-1">installation</a> section.</p><h3 id="gardener-extension-provider-metal"><a class="docs-heading-anchor" href="#gardener-extension-provider-metal">gardener-extension-provider-metal</a><a id="gardener-extension-provider-metal-1"></a><a class="docs-heading-anchor-permalink" href="#gardener-extension-provider-metal" title="Permalink"></a></h3><p>The <a href="https://github.com/metal-stack/gardener-extension-provider-metal">gardener-extension-provider-metal</a> contains of a set of webhooks and controllers for reconciling or mutating Gardener-specific resources.</p><p>The project also contains a validator for metal-type Gardener resources, which you should also deploy in case you want to use metal-stack in combination with Gardener.</p><h3 id="os-metal-extension"><a class="docs-heading-anchor" href="#os-metal-extension">os-metal-extension</a><a id="os-metal-extension-1"></a><a class="docs-heading-anchor-permalink" href="#os-metal-extension" title="Permalink"></a></h3><p>Due to the reason we use ignition in our operating system images for userdata, we had to provide an own extension controller for metal-stack, which you can find at Github in the <a href="https://github.com/metal-stack/os-metal-extension">os-metal-extension</a> repository.</p><h3 id="machine-controller-manager-provider-metal"><a class="docs-heading-anchor" href="#machine-controller-manager-provider-metal">machine-controller-manager-provider-metal</a><a id="machine-controller-manager-provider-metal-1"></a><a class="docs-heading-anchor-permalink" href="#machine-controller-manager-provider-metal" title="Permalink"></a></h3><p>Worker nodes are managed through Gardener&#39;s <a href="https://github.com/gardener/machine-controller-manager">machine-controller-manager</a> (MCM). The MCM allows out-of-tree provider implementation via sidecar, which is what we implemented in the <a href="https://github.com/metal-stack/machine-controller-manager-provider-metal">machine-controller-manager-provider-metal</a> repository.</p><h2 id="Gardener-with-metal-stack"><a class="docs-heading-anchor" href="#Gardener-with-metal-stack">Gardener with metal-stack</a><a id="Gardener-with-metal-stack-1"></a><a class="docs-heading-anchor-permalink" href="#Gardener-with-metal-stack" title="Permalink"></a></h2><h3 id="Introduction-into-Gardener"><a class="docs-heading-anchor" href="#Introduction-into-Gardener">Introduction into Gardener</a><a id="Introduction-into-Gardener-1"></a><a class="docs-heading-anchor-permalink" href="#Introduction-into-Gardener" title="Permalink"></a></h3><p><a href="https://gardener.cloud/">Gardener</a> is an open-source project and a system to manage Kubernetes clusters. Based on one cluster, other K8s clusters can be created by Gardener on many different cloud providers.</p><h3 id="Gardener-glossary"><a class="docs-heading-anchor" href="#Gardener-glossary">Gardener glossary</a><a id="Gardener-glossary-1"></a><a class="docs-heading-anchor-permalink" href="#Gardener-glossary" title="Permalink"></a></h3><p>At first, the most important Gardener terms are explained. More information can also be found in the <a href="https://github.com/gardener/documentation/blob/master/website/documentation/glossary/_index.md">glossary</a>.</p><p><strong>Garden Cluster</strong></p><p>A dedicated Kubernetes cluster that the Gardener control plane runs in. The Kubernetes cluster can be setup e.g. with Kubespray. The Garden cluster can also be used as seed cluster by deploying the Gardenlet into it.</p><p><strong>Virtual Garden</strong></p><p>Is a virtual cluster inside the Garden cluster. The virtual cluster is node less. Is is only a control plane node / cluster with the following components:</p><ul><li>garden kube-apiserver</li><li>etcd</li><li>kube-controller-manager</li></ul><p>More details about the value of a virtual garden can be found in the description of <a href="https://github.com/gardener/garden-setup/?tab=readme-ov-file#concept-the-virtual-cluster">garden-setup</a>.</p><p><strong>Gardener Control Plane Components</strong> The control plane components exist to manage the overall creation, modification and deletion of clusters. The components are the following:</p><ul><li>Gardener API Server</li><li>Gardener Controller Manager</li><li>Gardener Scheduler</li><li>Gardener Admission Controller</li></ul><p>The control plane components get deployed in the <code>garden cluster</code>.</p><p><strong>Gardener Agent Component</strong> Gardener has an agent component:</p><ul><li>Gardenlet</li></ul><p>The agent gets deployed in every seed cluster.</p><p><strong>Soil</strong> The soil cluster is the host for other seeds. It is the initital seed cluster, that is used for spinning up shooted seeds.</p><p><strong>Seed</strong> A cluster that hosts shoot cluster control planes as pods in order to manage shoot clusters. Taken from the <a href="https://github.com/gardener/documentation/blob/master/website/documentation/glossary/_index.md">glossary</a>.</p><p><strong>Shoot</strong> A Kubernetes runtime for the actual applications or services consisting of a shoot control plane running on the seed cluster and worker nodes hosting the actual workload. Taken from the <a href="https://github.com/gardener/documentation/blob/master/website/documentation/glossary/_index.md">glossary</a>.</p><hr/><h3 id="Initial-Cluster-Setup"><a class="docs-heading-anchor" href="#Initial-Cluster-Setup">Initial Cluster Setup</a><a id="Initial-Cluster-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Initial-Cluster-Setup" title="Permalink"></a></h3><p>Before creating the <code>garden cluster</code>, a base K8s cluster need to be in place: Some suggestions for the initial K8s cluster:</p><ul><li>GCP/GKE</li><li>metalstack.cloud</li><li>Kubespray</li></ul><p><strong>Initial Cluster on GCP</strong></p><ul><li>A GCP account need to be in place</li><li>Ansible <a href="https://github.com/metal-stack/ansible-common/tree/master/roles/gcp-auth">GCP auth role</a> can be used for authenticating against GCP</li><li>Ansible <a href="https://github.com/metal-stack/ansible-common/tree/master/roles/gcp-create">GCP create cluster role</a> can be used for creating the GCP cluster. </li></ul><p>Suggestions for default values are:</p><ul><li><code>gcp_machine_type</code>: e2-standard-8</li><li><code>gcp_autoscaling_min_nodes</code>: 1</li><li><code>gcp_autoscaling_max_nodes</code>: 3</li></ul><p><strong>Initial Cluster on metalstack.cloud</strong></p><ul><li>A Kubernetes cluster can be created on <a href="https://metalstack.cloud/de/documentation/UserManual#creating-a-cluster">metalstack.cloud</a> via UI, CLI or Terraform</li></ul><p><strong>Initial Cluster on a dedicated host via Kubespray</strong></p><ul><li>Could be done with Ansible and the default values for a cluster provided by <a href="https://github.com/kubernetes-sigs/kubespray/blob/master/playbooks/cluster.yml">Kubespray</a></li></ul><h3 id="metal-stack-Setup"><a class="docs-heading-anchor" href="#metal-stack-Setup">metal-stack Setup</a><a id="metal-stack-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#metal-stack-Setup" title="Permalink"></a></h3><blockquote><p><strong>Attention:</strong> Bootstrapping a meta-stack partition is out of scope and need to be done before focusing on the relationship between metal-stack and Gardener. This guide assumes a metal-stack partition (servers, switches, network, ...) is already in place.</p></blockquote><p>Start by deploying:</p><ul><li><code>ingress-nginx-controller</code></li><li><code>cert-manager</code></li></ul><p>This guide assumes, that metal-stack gets deployed on the same initial cluster as Gardener. On the initial cluster, the metal-stack control plane need to be deployed. This can be done as described in the metal-stack <a href="https://docs.metal-stack.io/stable/installation/deployment/#Metal-Control-Plane-Deployment">documentation</a>.</p><h3 id="Garden-Cluster-Setup"><a class="docs-heading-anchor" href="#Garden-Cluster-Setup">Garden Cluster Setup</a><a id="Garden-Cluster-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Garden-Cluster-Setup" title="Permalink"></a></h3><p>After setting up the initial K8s cluster and metal-stack, Gardener can be deployed with the <a href="https://github.com/metal-stack/metal-roles/tree/master/control-plane/roles/gardener">Gardener Ansible role</a>. This deploys the following components:</p><ul><li>virtual garden</li><li>Gardener control plane components</li><li>soil cluster</li><li>managed seed cluster (into the metal-stack partition)</li></ul><p>In summary, this results in the following:</p><ul><li><code>Garden cluster</code> created in the initial cluster</li><li><code>soil cluster</code> created in the initial cluster. This will be the <code>initial seed</code> used for spinning up <code>shooted seeds</code> in the metal-stack partition</li><li><code>shooted seed</code> inside the metal-stack partition, where all <code>shoots</code> are derived from</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../os/">« Operating Systems</a><a class="docs-footer-nextpage" href="../isolated-kubernetes/">Isolated Kubernetes »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Monday 25 November 2024 11:10">Monday 25 November 2024</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
