<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>metal-api as an Alternative Configuration Source for the firewall-controller · metal-stack</title><meta name="title" content="metal-api as an Alternative Configuration Source for the firewall-controller · metal-stack"/><meta property="og:title" content="metal-api as an Alternative Configuration Source for the firewall-controller · metal-stack"/><meta property="twitter:title" content="metal-api as an Alternative Configuration Source for the firewall-controller · metal-stack"/><meta name="description" content="Documentation for metal-stack."/><meta property="og:description" content="Documentation for metal-stack."/><meta property="twitter:description" content="Documentation for metal-stack."/><meta property="og:url" content="https://docs.metal-stack.io/development/proposals/MEP16/README/"/><meta property="twitter:url" content="https://docs.metal-stack.io/development/proposals/MEP16/README/"/><link rel="canonical" href="https://docs.metal-stack.io/development/proposals/MEP16/README/"/><script data-outdated-warner src="../../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../search_index.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script><link href="../../../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../../../assets/youtube.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="metal-stack logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../../">metal-stack</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Introduction</a></li><li><span class="tocitem">Overview</span><ul><li><a class="tocitem" href="../../../../overview/architecture/">Architecture</a></li><li><a class="tocitem" href="../../../../overview/networking/">Networking</a></li><li><a class="tocitem" href="../../../../overview/hardware/">Hardware Support</a></li><li><a class="tocitem" href="../../../../overview/os/">Operating Systems</a></li><li><a class="tocitem" href="../../../../overview/kubernetes/">Kubernetes Integration</a></li><li><a class="tocitem" href="../../../../overview/isolated-kubernetes/">Isolated Kubernetes</a></li><li><a class="tocitem" href="../../../../overview/gpu-support/">GPU Support</a></li><li><a class="tocitem" href="../../../../overview/storage/">Storage</a></li><li><a class="tocitem" href="../../../../overview/comparison/">Comparison</a></li></ul></li><li><a class="tocitem" href="../../../../quickstart/">Quickstart</a></li><li><span class="tocitem">Installation &amp; Administration</span><ul><li><a class="tocitem" href="../../../../installation/deployment/">Installation</a></li><li><a class="tocitem" href="../../../../installation/updates/">Releases and Updates</a></li><li><a class="tocitem" href="../../../../installation/monitoring/">Monitoring</a></li><li><a class="tocitem" href="../../../../installation/troubleshoot/">Troubleshoot</a></li></ul></li><li><span class="tocitem">User Guides</span><ul><li><a class="tocitem" href="../../../../external/mini-lab/README/">mini-lab</a></li><li><a class="tocitem" href="../../../../external/metalctl/README/">metalctl</a></li><li><a class="tocitem" href="../../../../external/csi-driver-lvm/README/">csi-driver-lvm</a></li><li><a class="tocitem" href="../../../../external/firewall-controller/README/">firewall-controller</a></li></ul></li><li><a class="tocitem" href="../../../../apidocs/apidocs/">API Documentation</a></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../../../client_libraries/">Client Libraries</a></li><li><a class="tocitem" href="../../../roadmap/">Roadmap</a></li><li><a class="tocitem" href="../../">Enhancement Proposals</a></li><li><a class="tocitem" href="../../../contributing/">Contributing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>metal-api as an Alternative Configuration Source for the firewall-controller</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>metal-api as an Alternative Configuration Source for the firewall-controller</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/metal-stack/docs.git" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="github.com/metal-stack/docs.git" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="metal-api-as-an-Alternative-Configuration-Source-for-the-firewall-controller"><a class="docs-heading-anchor" href="#metal-api-as-an-Alternative-Configuration-Source-for-the-firewall-controller">metal-api as an Alternative Configuration Source for the firewall-controller</a><a id="metal-api-as-an-Alternative-Configuration-Source-for-the-firewall-controller-1"></a><a class="docs-heading-anchor-permalink" href="#metal-api-as-an-Alternative-Configuration-Source-for-the-firewall-controller" title="Permalink"></a></h1><p>In the current situation, a firewall as provisioned by metal-stack is a fully immutable entity. Any modifications on the firewall like changing the firewall ruleset must be done <em>somehow</em> by the user – the metal-api and hence the metal-stack is not aware of its current state. </p><p>As part of our <a href="https://docs.metal-stack.io/stable/overview/kubernetes/#Gardener">integration with the Gardener project</a> we offer a solution called the <a href="https://github.com/metal-stack/firewall-controller">firewall-controller</a>, which is part of our <a href="https://github.com/metal-stack/metal-images/blob/6318a624861b18a559a9d37299bca5f760eef524/firewall/Dockerfile#L57-L58">firewall OS images</a> and addresses shortcomings of the firewall resource&#39;s immutability, which would otherwise be completely impractible to work with. The firewall-controller crashes infinitely if it is not properly configured through the userdata when using the firewall image of metal-stack.</p><p>The firewall-controller approach is tightly coupled to the Gardener and it requires the administrator of the Gardener installation to pass a shoot and a seed kubeconfig through machine userdata when creating the firewall. How this userdata has to look like is not documented and is just part of another project called the <a href="https://github.com/metal-stack/firewall-controller-manager">firewall-controller-manager</a>, which task is to orchestrate rolling updates of firewall machines in a way that network traffic interruption is minimal when updating a firewall or applying a change to an immutable firewall configuration.</p><p>In general, a firewall entity in metal-stack has similarities to the machine entity but it has a fundamental difference: A user gains ownership over a machine after provisioning. They can access it through SSH, modify it at will and this is completely wanted. For firewalls, however, we do not want a user to access the provisioned firewall as the firewall is a privileged part of the infrastructure with access to the underlay network. The underlay can not be tampered with at any given point in time by a user as it can destroy the entire network traffic flow inside a metal-stack partition.</p><p>For this reason, we have a gap in the metal-stack project in terms of a missing solution for people who do not rely on the Gardener integration. We are basically leaving a user with the option to implement an orchestrated recreation of every possible change on the firewall to minimize traffic interruption for the machines sitting behind the firewall or re-implement the firewall-controller to how they want to use it for their use-case. Also we do not have a clear distinction in the API between user and landscape operator for firewalls. If a user would allocate firewall it is also possible for the user to inject his own SSH keys and access the firewall and tamper with the underlay network. </p><p>Parts of these problems are probably going to decrease with the work on <a href="../../MEP4/README/">MEP-4</a> where there will be dedicated APIs for users and administrators of metal-stack including fine-grained access tokens.</p><p>With this MEP we want to describe a way to improve this current situation and allow other users that do not rely on the Gardener integration – for whatever motivation they have not to – to adequately manage firewalls. For this, we propose an alternative configuration for the firewall-controller that is more versatile and independent of the Gardener.</p><h2 id="Proposal"><a class="docs-heading-anchor" href="#Proposal">Proposal</a><a id="Proposal-1"></a><a class="docs-heading-anchor-permalink" href="#Proposal" title="Permalink"></a></h2><ul><li>The firewall rules of the firewall entity can be updated through the metal-api.</li><li>The firewall-controller can be configured through a dedicated config file.</li><li>Inside this config file the data source for all its dynamic configuration tasks can be set independently.</li><li>For example the data source of the core firewall rules could be set the Gardener seed or the metal-api firewall entity, while the CWNPs should be fetched and applied from a given kubeconfig.</li><li>This configuration file is intended to be injected through userdata along with potential source connection credentials.</li></ul><pre><code class="language-yaml hljs"># the main configuration source contributes
# - firewall nftables rules
# - egress rules
# - prefixes
# - rate limiting
# - versions of components (firewall-controller, droptailer, ...)
main:
  kind: kubernetes
  config:
    kubeconfigPath: /etc/firewall-controller/seed.yaml
    components:
    - kind: Firewall
      namespace: shoot-namespace

# the additional configuration sources contributes
# - additional firewall nftables rules
additional:
- kind: kubernetes
  config:
    kubeconfigPath: /etc/firewall-controller/shoot.yaml
    components:
    - kind: ClusterwideNetworkPolicy
      namespace: firewall
    - kind: Service
      namespace: null

- kind: metal-api
  config:
    url: https://metal-api
    hmac: some-hmac
    type: Metal-View

- kind: static
  config:
    egress: []
    ingress: []

# the reports configuration output generates
# - FirewallMonitor
reports:
- kind: kubernetes
  config:
    kubeconfigPath: /etc/firewall-controller/shoot.yaml
    components:
    - kind: FirewallMonitor
      namespace: firewall
      name: firewall-monitor # default name of firewall</code></pre><h3 id="Non-Goals"><a class="docs-heading-anchor" href="#Non-Goals">Non-Goals</a><a id="Non-Goals-1"></a><a class="docs-heading-anchor-permalink" href="#Non-Goals" title="Permalink"></a></h3><ul><li>Resolving the missing differentiation between users and administrators by lettings users pass userdata and SSH keys to the firewall creation.<ul><li>This is even more related to MEP-4 than this MEP.</li></ul></li></ul><h3 id="Advantages"><a class="docs-heading-anchor" href="#Advantages">Advantages</a><a id="Advantages-1"></a><a class="docs-heading-anchor-permalink" href="#Advantages" title="Permalink"></a></h3><ul><li>Offers a native metal-stack solution that improves managing firewalls for users by adding dynamic reconfiguration through the metal-api</li><li>Improve consistency throughout the API (firewall rules would reflect what is in metal-api)</li><li>Other providers like Cluster API can leverage this approach, too</li><li>It can contribute to solving the shoot migration issue (in Cluster API case the <code>clusterctl move</code> for firewall objects)<ul><li>For Gardener takes the seed out of the equation (of which the kubeconfig changes during shoot migration)</li><li>However: Things like egress rules, rate limiting, etc. are currently not part of the firewall entity in the metal-api (these would need to be added to the firewall entity as otherwise there is no feature parity)</li></ul></li></ul><h3 id="Caveats"><a class="docs-heading-anchor" href="#Caveats">Caveats</a><a id="Caveats-1"></a><a class="docs-heading-anchor-permalink" href="#Caveats" title="Permalink"></a></h3><ul><li>Metal-View access is too broad for firewalls. Mitigated by MEP-4.</li><li>Polling of the firewall-controller is bad for performance. Mitigated by MEP-4.</li></ul><h3 id="Firewall-Controller-Manager"><a class="docs-heading-anchor" href="#Firewall-Controller-Manager">Firewall Controller Manager</a><a id="Firewall-Controller-Manager-1"></a><a class="docs-heading-anchor-permalink" href="#Firewall-Controller-Manager" title="Permalink"></a></h3><ul><li>firewall-controller<ul><li>Allow OPTIONAL configuration source (metal-api with view HMAC), which is considered when no seed kubeconfig was passed in the userdata</li></ul></li><li>firewall-controller-manager<ul><li>Update the firewall entity in the metal-api</li></ul></li><li>metal-api<ul><li>Allow update of firewall rules in the machine allocation spec</li><li>Add egress rules, rate limiting, etc to the firewall entity</li></ul></li></ul><pre><code class="language-yaml hljs">kind: FirewallDeployment
spec:
    userdataContents:
    - path: /etc/firewall-controller/config.yaml
      content: |
        ---
        main:
        additional:
        reports:
    - path: /etc/firewall-controller/seed.yaml
      secretRef:
          name: seed-kubeconfig
    - path: /etc/firewall-controller/shoot.yaml
      secretRef:
          name: shoot-kubeconfig
    - path: /etc/firewall-controller/shoot.yaml
      generateSecret: true # TODO which? :D</code></pre><h3 id="Cluster-API-Provider-Metal-Stack"><a class="docs-heading-anchor" href="#Cluster-API-Provider-Metal-Stack">Cluster API Provider Metal Stack</a><a id="Cluster-API-Provider-Metal-Stack-1"></a><a class="docs-heading-anchor-permalink" href="#Cluster-API-Provider-Metal-Stack" title="Permalink"></a></h3><p>The proposed changes would allow the cluster-api-provider-metal-stack to be able to manage firewalls to the same extent as metal-stack can with Gardener. Here the firewall would need to be configured to use a kubeconfig to a cluster to reconcil<code>CWNP</code>s and the <code>FirewallMonitor</code>. This cluster might be a separate monitoring or configuration cluster that is accessible by the firewall and the FCM or the workload cluster itself if the CRDs are installed.</p><p>Once the firewall-controller is able to update the status of the <code>FirewallMonitor</code>, the FCM is able to perform battle proof rolling updates of the firewall. Due to the fact that the bootstrap cluster is typically being run in a kind cluster, there is no way for the firewall-controller to access the <code>Firewall</code> resource within. By using the metal-api as a data source, there is now a way for the firewall-controller to operate on.</p><ul><li>firewall-controller<ul><li>for FirewallMonitor and CWNP use user provided SecretRef to Kubeconfig </li><li>for LoadBalancer use workload cluster kubeconfig</li></ul></li></ul><pre><code class="language-yaml hljs">kind: MetalStackCluster
metadata:
    # existing fields omitted
spec:
    firewallTemplate:
        # existing fields omitted
        staticRuleSet: []
        controllerConfig: |
            ---
            main:
            additional:
            reports:
        additionalFiles:</code></pre><h2 id="Roadmap"><a class="docs-heading-anchor" href="#Roadmap">Roadmap</a><a id="Roadmap-1"></a><a class="docs-heading-anchor-permalink" href="#Roadmap" title="Permalink"></a></h2><p>In general this proposal is not thought to be implemented in one batch. Instead an incremental approach is required.</p><ol><li>Allow Cluster API to use the FCM (provide immutable firewalls that run without firewall-controller).<ul><li>Add <code>spec.staticRuleSet</code> to Firewall.</li><li>Add <code>firewall.metal-stack.io/paused</code> annotation (managed by CAPMS during move, theoretically useful for Gardener shoot migration as well to avoid shallow deletion).</li><li>Reconcile multiple <code>FirewallDeployment</code> resources per namespace.</li><li>Allow setting the <code>firewall.metal-stack.io/no-controller-connection</code> annotation through the <code>FirewallDeployment</code> (either through the template or inheritance)</li></ul></li><li>Extend firewall-controller with the configuration file (no different data sources than kubernetes) and let the FCM generate this configuration file along with the rest of the userdata.</li><li>Add metal-api as configuration source.<ul><li>Allow updates of firewall rules in the firewall entity.</li><li>For Cluster API: Let the cluster controller generate the userdata including the configuration for this additional data source.</li></ul></li><li>Move to more generic interface for the FCM (remove Gardener coupling)</li></ol><h2 id="Alternatives-Considered"><a class="docs-heading-anchor" href="#Alternatives-Considered">Alternatives Considered</a><a id="Alternatives-Considered-1"></a><a class="docs-heading-anchor-permalink" href="#Alternatives-Considered" title="Permalink"></a></h2><ul><li>instead of the generic data sources, for each mechanism a kubeconfig could be provided. Though this is not a scalable nor flexible approach. In the end the same internal data structure is still needed.</li></ul></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Thursday 13 March 2025 14:46">Thursday 13 March 2025</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
