<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Firewall Support for Cluster API Provider · metal-stack</title><meta name="title" content="Firewall Support for Cluster API Provider · metal-stack"/><meta property="og:title" content="Firewall Support for Cluster API Provider · metal-stack"/><meta property="twitter:title" content="Firewall Support for Cluster API Provider · metal-stack"/><meta name="description" content="Documentation for metal-stack."/><meta property="og:description" content="Documentation for metal-stack."/><meta property="twitter:description" content="Documentation for metal-stack."/><meta property="og:url" content="https://docs.metal-stack.io/development/proposals/MEP16/README/"/><meta property="twitter:url" content="https://docs.metal-stack.io/development/proposals/MEP16/README/"/><link rel="canonical" href="https://docs.metal-stack.io/development/proposals/MEP16/README/"/><script data-outdated-warner src="../../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../search_index.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script><link href="../../../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../../../assets/youtube.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="metal-stack logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../../">metal-stack</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Introduction</a></li><li><span class="tocitem">Overview</span><ul><li><a class="tocitem" href="../../../../overview/architecture/">Architecture</a></li><li><a class="tocitem" href="../../../../overview/networking/">Networking</a></li><li><a class="tocitem" href="../../../../overview/hardware/">Hardware Support</a></li><li><a class="tocitem" href="../../../../overview/os/">Operating Systems</a></li><li><a class="tocitem" href="../../../../overview/kubernetes/">Kubernetes Integration</a></li><li><a class="tocitem" href="../../../../overview/isolated-kubernetes/">Isolated Kubernetes</a></li><li><a class="tocitem" href="../../../../overview/gpu-support/">GPU Support</a></li><li><a class="tocitem" href="../../../../overview/storage/">Storage</a></li><li><a class="tocitem" href="../../../../overview/comparison/">Comparison</a></li></ul></li><li><a class="tocitem" href="../../../../quickstart/">Quickstart</a></li><li><span class="tocitem">Installation &amp; Administration</span><ul><li><a class="tocitem" href="../../../../installation/deployment/">Installation</a></li><li><a class="tocitem" href="../../../../installation/updates/">Releases and Updates</a></li><li><a class="tocitem" href="../../../../installation/monitoring/">Monitoring</a></li><li><a class="tocitem" href="../../../../installation/troubleshoot/">Troubleshoot</a></li></ul></li><li><span class="tocitem">User Guides</span><ul><li><a class="tocitem" href="../../../../external/mini-lab/README/">mini-lab</a></li><li><a class="tocitem" href="../../../../external/metalctl/README/">metalctl</a></li><li><a class="tocitem" href="../../../../external/csi-driver-lvm/README/">csi-driver-lvm</a></li><li><a class="tocitem" href="../../../../external/firewall-controller/README/">firewall-controller</a></li></ul></li><li><a class="tocitem" href="../../../../apidocs/apidocs/">API Documentation</a></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../../../client_libraries/">Client Libraries</a></li><li><a class="tocitem" href="../../../roadmap/">Roadmap</a></li><li><a class="tocitem" href="../../">Enhancement Proposals</a></li><li><a class="tocitem" href="../../../contributing/">Contributing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Firewall Support for Cluster API Provider</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Firewall Support for Cluster API Provider</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/metal-stack/docs.git" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="github.com/metal-stack/docs.git" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Firewall-Support-for-Cluster-API-Provider"><a class="docs-heading-anchor" href="#Firewall-Support-for-Cluster-API-Provider">Firewall Support for Cluster API Provider</a><a id="Firewall-Support-for-Cluster-API-Provider-1"></a><a class="docs-heading-anchor-permalink" href="#Firewall-Support-for-Cluster-API-Provider" title="Permalink"></a></h1><p>Currently the creation and management of firewalls is out of scope for the <a href="https://github.com/metal-stack/cluster-api-provider-metal-stack">Cluster API Provider metal-stack</a>, or in short capms. In practice this requires operators to create the firewall and therefore also the node network before generating the cluster. When either the firewall rules, the firewall image or the firewall machine size change, this requires the operator to manually roll the firewall by creating a new one and deleting the old firewall. </p><p>To gain a production ready implementation for Cluster API to automatically manage the deployment of firewalls, it makes sense to build on top of prior art. In case of Gardener on metal-stack the <a href="https://github.com/metal-stack/firewall-controller-manager">Firewall Controller Manager</a>, or short fcm, is used. </p><h2 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h2><p>The capms controller manager should now create the node network if needed. And when a firewall template exists for the cluster, a firewall deployment should be created and updated on every change.</p><p>The fcm should now observe all firewall deployments across all namespaces. It then creates firewall sets and later firewalls. It handles and implement rolling updates.</p><h2 id="Implementation"><a class="docs-heading-anchor" href="#Implementation">Implementation</a><a id="Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation" title="Permalink"></a></h2><p>During reconciliation the capms controller manager has a look at <code>MetalStackCluster.Spec.NodeNetworkID</code>. If it is not yet set, the node network should created and patched back into the spec. Then the manager should move to the <code>MetalStackCluster.Spec.FirewallTemplate</code>. When set, it should create or update the matching <code>FirewallDeployment</code> according to the nested data like the image, networks, size or the <code>FirewallDeployment.Spec.Template.InitialRuleSet</code>.</p><p>From here on the fcm will take over to reconcile all <code>FirewallDeployment</code>s. Currently it only watches a specific namespace and needs to be adapted to be capable of operating on all namespaces instead. Also initial firewall rule sets need to be implemented.</p><p>When the operator installs Cluster API including capms into their cluster, <code>clusterctl init --infrastructure metal-stack</code> needs to include the fcm custom resources and optionally its controller deployment to be able to reconcile firewalls.</p><p>When generating a new cluster using <code>clusterctl generate cluster --infrastructure metal-stack cluster-name</code>, this should also generate a firewall entry including some basic firewall rules.</p><pre><code class="language-yaml hljs">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
kind: MetalStackCluster
metadata:
  name: cluster-name
  namespace: default
spec:
  projectID: some-project-id
  partition: partition
  nodeNetworkID: node-network-id # now optional if firewall given
  firewallTemplate:
    size: machine-size
    image: firewall-ubuntu
    networks: [] # the node-network-id will be appended automatically
    initialRuleSet:
      ingress:
      - comment: allow incoming https
        protocol: tcp
        ports: [443]
        from: [0.0.0.0/0]
      egress:
      - comment: allow outgoing https
        protocol: tcp
        ports: [443]
        to: [0.0.0.0/0]
      # additional entries for dns, ssh and ntp required</code></pre><p>Cluster API allows to move the resource and therefore the control over the bootstrapped workload cluster. As part of this process <code>clusterctl</code> marks the cluster as paused. Providers like capms need to obey the pause and may not reconcile during this time period to avoid loss of infrastructure and data.</p><p>When using the fcm in this context, it should also obey this rule. But in order to keep the fcm separated from cluster api internals, we&#39;d like to propose the <code>firewall.metal-stack.io/paused</code> annotation to pause the reconciliation. Managing this pause annotation on the <code>FirewallDeployment</code> is in the responsibility of the capms controller manager.</p><p>This annotation still needs to be propagated to nested resources like <code>FirewallSet</code> and <code>Firewall</code>.</p><p>Furthermore Cluster API also requires to have an unbroken chain of owner references. In practice this means <code>Firewall</code> is owned by <code>FirewallSet</code> which is in turn owned by <code>FirewallDeployment</code>. This is a <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/owners-dependents/">Kubernetes feature</a> and good practice anyways.</p><h2 id="Affected-Components"><a class="docs-heading-anchor" href="#Affected-Components">Affected Components</a><a id="Affected-Components-1"></a><a class="docs-heading-anchor-permalink" href="#Affected-Components" title="Permalink"></a></h2><p>For some working items, we already created proof of concept PRs, which might need to be split up and are not yet production ready.</p><ul><li>Firewall Controller Manager<ul><li>must be configured to watch all namespaces for <code>FirewallDeployment</code> <a href="https://github.com/metal-stack/firewall-controller-manager/pull/66">fcm#66</a></li><li>initial firewall rules needs to be implemented <a href="https://github.com/metal-stack/firewall-controller-manager/pull/64">fcm#64</a></li><li>the annotations of the <code>FirewallDeployment</code> need to be propagated down to the <code>FirewallSet</code> and <code>Firewall</code></li><li>needs to introduce and implement the <code>firewall.metal-stack.io/paused</code> annotation</li><li>set owner references to <code>FirewallSet</code> and <code>Firewall</code></li></ul></li><li>Cluster API Controller Manager<ul><li>the <code>FirewallDeployment</code> pause annotation needs to be managed</li><li>the <code>FirewallDeployment</code> resource should be created if template set <a href="https://github.com/metal-stack/cluster-api-provider-metal-stack/pull/82">capms#82</a></li><li>management of SSH keys for machines and firewalls <a href="https://github.com/metal-stack/cluster-api-provider-metal-stack/pull/82">capms#82</a></li><li>cluster-template<ul><li>needs to install CRDs for the FCM in order to be respected during moves <a href="https://github.com/metal-stack/cluster-api-provider-metal-stack/pull/82">capms#82</a></li><li>eventually also install the FCM itself</li></ul></li><li><code>MetalStackCluster</code> resource definition<ul><li>add <code>MetalStackCluster.Spec.FirewallTemplate</code></li><li>make <code>Spec.NodeNetworkID</code> optional if <code>Spec.FirewallTemplate</code> given</li></ul></li></ul></li></ul><h2 id="Caveats-and-Organizational-Implications"><a class="docs-heading-anchor" href="#Caveats-and-Organizational-Implications">Caveats and Organizational Implications</a><a id="Caveats-and-Organizational-Implications-1"></a><a class="docs-heading-anchor-permalink" href="#Caveats-and-Organizational-Implications" title="Permalink"></a></h2><p>When the cluster is pivoted and reconciles its own firewall, a malfunctioning firewall prevents the cluster from self-healing and requires manual intervention by creating a new firewall. This is an inherent problem of the cluster-api approach. It can be circumvented by using an extra cluster to manage workload clusters.</p><p>In the current form of this approach firewalls and therefore the firewall egress and ingress rules are managed by the cluster operators that manage the cluster-api resources. Hence it will not be possible to gain a fine-grained control over every cluster operator&#39;s choices from a central ruleset at the level of metal-stack firewalls. In case this control surfaces as a requirement, it would need to be implemented in a firewall external to metal-stack.</p></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Wednesday 12 March 2025 10:53">Wednesday 12 March 2025</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
