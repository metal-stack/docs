<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Multi-Tenancy for the metal-api · metal-stack</title><link rel="canonical" href="https://docs.metal-stack.io/development/proposals/MEP4/README/"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script><link href="../../../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../../../assets/youtube.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="metal-stack logo"/></a><div class="docs-package-name"><span class="docs-autofit">metal-stack</span></div><form class="docs-search" action="../../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Introduction</a></li><li><span class="tocitem">Overview</span><ul><li><a class="tocitem" href="../../../../overview/architecture/">Architecture</a></li><li><a class="tocitem" href="../../../../overview/networking/">Networking</a></li><li><a class="tocitem" href="../../../../overview/hardware/">Hardware Support</a></li><li><a class="tocitem" href="../../../../overview/os/">Operating Systems</a></li><li><a class="tocitem" href="../../../../overview/kubernetes/">Kubernetes Integration</a></li><li><a class="tocitem" href="../../../../overview/storage/">Storage</a></li><li><a class="tocitem" href="../../../../overview/comparison/">Comparison</a></li></ul></li><li><a class="tocitem" href="../../../../quickstart/">Quickstart</a></li><li><span class="tocitem">Installation &amp; Administration</span><ul><li><a class="tocitem" href="../../../../installation/deployment/">Installation</a></li><li><a class="tocitem" href="../../../../installation/monitoring/">Monitoring</a></li><li><a class="tocitem" href="../../../../installation/troubleshoot/">Troubleshoot</a></li></ul></li><li><span class="tocitem">User Guides</span><ul><li><a class="tocitem" href="../../../../external/mini-lab/README/">mini-lab</a></li><li><a class="tocitem" href="../../../../external/metalctl/README/">metalctl</a></li><li><a class="tocitem" href="../../../../external/csi-driver-lvm/README/">csi-driver-lvm</a></li><li><a class="tocitem" href="../../../../external/firewall-controller/README/">firewall-controller</a></li></ul></li><li><a class="tocitem" href="../../../../apidocs/apidocs/">API Documentation</a></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../../../client_libraries/">Client Libraries</a></li><li><a class="tocitem" href="../../../roadmap/">Roadmap</a></li><li><a class="tocitem" href="../../">Enhancement Proposals</a></li><li><a class="tocitem" href="../../../contributing/">Contributing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Multi-Tenancy for the metal-api</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Multi-Tenancy for the metal-api</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/metal-stack/docs/blob/master/docs/src/development/proposals/MEP4/README.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Multi-Tenancy-for-the-metal-api"><a class="docs-heading-anchor" href="#Multi-Tenancy-for-the-metal-api">Multi-Tenancy for the metal-api</a><a id="Multi-Tenancy-for-the-metal-api-1"></a><a class="docs-heading-anchor-permalink" href="#Multi-Tenancy-for-the-metal-api" title="Permalink"></a></h1><div class="admonition is-info"><header class="admonition-header">Info</header><div class="admonition-body"><p>This document is work in progress.</p></div></div><p>In the past we decided to treat the metal-api as a &quot;low-level API&quot;, i.e. the API does not specifically deal with projects and tenants. A user with editor access can for example assign machines to every project he desires, he can see all the machines available and can control them.</p><p>Even though we always tried to reserve the possibility to sell metal-stack as a bare metal machine provider only, the ultimate objective to us has always been to create an API for Kubernetes clusters. Hence, we tried to keep the metal-api code base as small as possible and we added resource scoping to a &quot;higher-level API&quot;, the cloud-api, a component that is not open-source. From there, a user would be able to only see his own clusters.</p><p>As time passed by, things changed: The metal-stack has become an open-source project and people are willing to adopt. Adopters don&#39;t have the cloud-api and they are interested in putting their own technologies on top of the metal-stack infrastructure. Introducing multi-tenancy to the metal-api is a serious chance of making our product better and more successful as it opens the door for:</p><ul><li>Becoming a &quot;fully-featured&quot; cloud provider with bare metal servers, networks and ip addresses treated as first-class citizens</li><li>Letting untrusted / third-parties work with the API</li><li>Narrowing down attack surfaces (through user roles and fine-grained permissions)</li><li>Gaining performance through resource scopes</li><li>Using the Gardener Dashboard (no need for individual metal-stack deployments per tenant)</li><li>Discouraging people to implement their own scoping layers in front of the metal-stack</li></ul><p>With these traits in place, wild ideas for the future come to mind:</p><ul><li>Having a public offering of metal-stack</li><li>Allowing users to bring their own partitions (managed control plane)</li></ul><h2 id="Table-of-Contents"><a class="docs-heading-anchor" href="#Table-of-Contents">Table of Contents</a><a id="Table-of-Contents-1"></a><a class="docs-heading-anchor-permalink" href="#Table-of-Contents" title="Permalink"></a></h2><ul><li><a href="#Multi-Tenancy-for-the-metal-api">Multi-Tenancy for the metal-api</a></li><ul><li><a href="#Table-of-Contents">Table of Contents</a></li><li><a href="#User-Scenarios">User Scenarios</a></li><ul><li><a href="#Project-Creation">Project Creation</a></li><li><a href="#Machine-Creation">Machine Creation</a></li><li><a href="#Admin-Machine-Maintenance">Admin Machine Maintenance</a></li><li><a href="#Custom-Role-Permissions">Custom Role Permissions</a></li></ul><li><a href="#Centralized-vs.-Decentralized-User-Management">Centralized vs. Decentralized User Management</a></li><ul><li><a href="#Global-and-User-Scopes-for-Resources">Global &amp; User Scopes for Resources</a></li><li><a href="#Auditing">Auditing</a></li></ul><li><a href="#Implementation">Implementation</a></li><ul><li><a href="#API-v2">API v2</a></li><li><a href="#Resource-Paths">Resource Paths</a></li><ul><li><a href="#Example">Example</a></li></ul><li><a href="#Permission-Wildcards">Permission Wildcards</a></li><li><a href="#Scoping">Scoping</a></li></ul><li><a href="#Migration-Path">Migration Path</a></li><ul><li><a href="#Migrate-Existing-Gardener-Projects-to-New-API">Migrate Existing Gardener Projects to New API</a></li></ul></ul></ul><h2 id="User-Scenarios"><a class="docs-heading-anchor" href="#User-Scenarios">User Scenarios</a><a id="User-Scenarios-1"></a><a class="docs-heading-anchor-permalink" href="#User-Scenarios" title="Permalink"></a></h2><p>This is a collection of workflows from the perspective of a user that we want to provide after the implementation of this proposal.</p><h3 id="Project-Creation"><a class="docs-heading-anchor" href="#Project-Creation">Project Creation</a><a id="Project-Creation-1"></a><a class="docs-heading-anchor-permalink" href="#Project-Creation" title="Permalink"></a></h3><p>A regular user wants to create a project to later maintain multiple resources inside this project&#39;s workspace.</p><ul><li>The user has to login before he can interact with the API. The login command will open a browser window as implemented already.<pre><code class="language-none">$ metalctl login</code></pre></li><li>A user is always associated with a tenant.<pre><code class="language-none">$ metalctl whoami
UserId: gerrit
Email: gerrit@gerrit.gerrit
Tenant: my-tenant
Issuer: https://dex.test.io/dex
Expires at Thu Jul 22 00:07:09 CEST 2021</code></pre></li><li>The user has permissions to create a project.<pre><code class="language-none">$ metalctl show-permissions
Project:
Roles:
  metal-stack-user
Permissions:
  metal.v2.project.list
  metal.v2.project.get
  metal.v2.project.delete
  metal.v2.project.create
  metal.v2.project.update
Resources:
  *</code></pre></li><li>The user can create the project.<pre><code class="language-none">$ metalctl project create --name my-project
...</code></pre></li><li>A user has the option to direct all requests to a certain project (just like context switch)<pre><code class="language-none">$ metalctl project set 793bb6cd-8b46-479d-9209-0fedca428fe1
You are now acting on project 793bb6cd-8b46-479d-9209-0fedca428fe1.</code></pre></li><li>The user now has the <code>project-owner</code> role has an owner role and typical owner permissions on the newly created project.<pre><code class="language-none">$ metalctl show-permissions
Project: 793bb6cd-8b46-479d-9209-0fedca428fe1
Roles:
  metal-stack-user
  metal-stack-project-owner
Permissions:
  metal.v2.image.list
  metal.v2.image.get
  metal.v2.image.get-latest
  metal.v2.ip.list
  metal.v2.ip.get
  metal.v2.ip.create
  metal.v2.ip.delete
  metal.v2.ip.update
  metal.v2.machine.list
  metal.v2.machine.get
  metal.v2.machine.create
  metal.v2.machine.delete
  metal.v2.machine.update
  metal.v2.network.list
  metal.v2.network.get
  metal.v2.network.create-child
  metal.v2.network.delete-child
  metal.v2.network.update-child
  metal.v2.project.list
  metal.v2.project.get
  metal.v2.project.delete
  metal.v2.project.create
  metal.v2.project.update
  ...more typical user permissions...
Resources:
  *</code></pre></li></ul><h3 id="Machine-Creation"><a class="docs-heading-anchor" href="#Machine-Creation">Machine Creation</a><a id="Machine-Creation-1"></a><a class="docs-heading-anchor-permalink" href="#Machine-Creation" title="Permalink"></a></h3><p>A regular user wants to create a machine resource.</p><p>Requirements: Project was created</p><ul><li>By default, the user can see networks that were provided by the admin.<pre><code class="language-none">$ metalctl network ls
ID                                      NAME                     PROJECT     PARTITION       NAT     SHARED  PREFIXES         IPS
internet                                Internet Network                                     true    false   212.34.83.0/27    ●
tenant-super-network-fra-equ01          Project Super Network                fra-equ01       false   false   10.128.0.0/14     ●
underlay-fra-equ01                      Underlay Network                     fra-equ01       false   false   10.0.0.0/16       ●</code></pre></li><li>The user has to set the project scope first or provide <code>--project</code> flags for all commands.<pre><code class="language-none">$ metalctl project set 793bb6cd-8b46-479d-9209-0fedca428fe1
You are now acting on project 793bb6cd-8b46-479d-9209-0fedca428fe1.</code></pre></li><li>The user can create the child network required for machine allocation.<pre><code class="language-none">$ metalctl network allocate --partition fra-equ01 --name test</code></pre></li><li>Now, the user sees his own child network.<pre><code class="language-none">$ metalctl network ls
ID                                      NAME                    PROJECT                                 PARTITION       NAT     SHARED  PREFIXES         IPS
internet                                Internet Network                                                                true    false   212.34.83.0/27    ●
tenant-super-network-fra-equ01          Project Super Network                                           fra-equ01       false   false   10.128.0.0/14     ●
└─╴08b9114b-ec47-4697-b402-a11421788dc6 test                    793bb6cd-8b46-479d-9209-0fedca428fe1    fra-equ01       false   false   10.128.64.0/22    ●
underlay-fra-equ01                      Underlay Network                                                fra-equ01       false   false   10.0.0.0/16       ●</code></pre></li><li>The user does not see any machines yet.<pre><code class="language-none">$ metalctl machine ls</code></pre></li><li>The user can create a machine.<pre><code class="language-none">$ metalctl machine create --networks internet,08b9114b-ec47-4697-b402-a11421788dc6 --name test --hostname test --image ubuntu-20.04 --partition fra-equ01 --size c1-xlarge-x86`</code></pre></li><li>The machine will now be provisioned.<pre><code class="language-none">$ metalctl machine ls
ID                                     LAST EVENT      WHEN    AGE      HOSTNAME   PROJECT                                 SIZE            IMAGE                   PARTITION
00000000-0000-0000-0000-ac1f6b7befb2   Phoned Home     20s     50d 4h   test       793bb6cd-8b46-479d-9209-0fedca428fe1    c1-xlarge-x86   Ubuntu 20.04 20210415   fra-equ01</code></pre></li></ul><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>A user <strong>cannot</strong> list all allocated machines for all projects. The user <strong>must</strong> always switch project context first and can only view the machines inside this project.</p></div></div><h3 id="Admin-Machine-Maintenance"><a class="docs-heading-anchor" href="#Admin-Machine-Maintenance">Admin Machine Maintenance</a><a id="Admin-Machine-Maintenance-1"></a><a class="docs-heading-anchor-permalink" href="#Admin-Machine-Maintenance" title="Permalink"></a></h3><p>Admins should be able to see &quot;everything&quot;, even resources of tenant&#39;s regular users. The reasons why this user needs these privileged rights is:</p><ol><li>Recover machines a tenant can&#39;t recover themselves (due to software bug)</li><li>When a tenant leaves, resources may need to be cleaned up</li><li>The admin should generally be able to observe the health of the entire installation</li><li>Admins have set up the environment and are likely to have access to all the databases, such they were able to compromise the environment anyway</li></ol><ul><li>The user has permissions to create a project.<pre><code class="language-none">$ metalctl show-permissions
Project: *
Roles:
  metal-stack-admin
Permissions:
  metal.v2.*
Resources:
  *</code></pre></li><li>The admin user can see all machines there are.<pre><code class="language-none">$ metalctl machine ls
ID                                        LAST EVENT      WHEN     AGE       HOSTNAME                        PROJECT                                 SIZE                  IMAGE                           PARTITION
00000000-0000-0000-0000-ac1f6b7befb2      Phoned Home     4s       50d 4h    storage-2                       a0a4c959-b191-4b4d-8483-951ccc2ff3f1    c1-xlarge-x86         Centos 7 20210415               fra-equ01
00000000-0000-0000-0000-0025905f207a      Phoned Home     5s       103d 15m  shoot--phjjb...-firewall-0f96d  5820c4e7-fbd4-4e4b-a40b-2b83eb34bbe1    s1-large-x86          Firewall 2 Ubuntu 20210304      fra-equ01
00000000-0000-0000-0000-ac1f6b7b77c8      Phoned Home     5s       65d 8h    shoot--test-...-firewall-cf20f  00000000-0000-0000-0000-000000000001    c1-xlarge-x86         Firewall 2 Ubuntu 20210316      fra-equ01
00000000-0000-0000-0000-ac1f6bd390a6      Waiting         59s                                                                                                                                              fra-equ01
00000000-0000-0000-0000-0025905f2032      Phoned Home     4s       8d 1h     shoot--p5c7f...-firewall-c72be  5410a72d-14c1-424e-9896-71c7ee84d393    s1-large-x86          Firewall 2 Ubuntu 20210606      fra-equ01
00000000-0000-0000-0000-ac1f6b7aeb90      Phoned Home     4s       50d 4h    storage-0                       a0a4c959-b191-4b4d-8483-951ccc2ff3f1    c1-xlarge-x86         Centos 7 20210415               fra-equ01
00000000-0000-0000-0000-ac1f6b7aeb76      Phoned Home     4s       1d 16h    shoot--pskqm...p-0-576df-6f552  b5f26a3b-9a4d-48db-a6b3-d1dd4ac4abec    c1-xlarge-x86         Debian 10 20210719              fra-equ01
00000000-0000-0000-0000-ac1f6b7d7efa      Phoned Home     56s      105d 2h   shoot--phjjb...p-0-77fc5-sr5zn  5820c4e7-fbd4-4e4b-a40b-2b83eb34bbe1    s2-xlarge-x86         Debian 10 20210316              fra-equ01
00000000-0000-0000-0000-ac1f6b7b77cc      Phoned Home     4s       50d 4h    storage-1                       a0a4c959-b191-4b4d-8483-951ccc2ff3f1    c1-xlarge-x86         Centos 7 20210415               fra-equ01
00000000-0000-0000-0000-ac1f6b7d7e32      Phoned Home     4s       105d 2h   shoot--phjjb...p-0-77fc5-qldng  5820c4e7-fbd4-4e4b-a40b-2b83eb34bbe1    s2-xlarge-x86         Debian 10 20210316              fra-equ01
11111111-2222-3333-4444-aabbccddeeff      Waiting         6s                                                                                         s1-large-broken-x86                                   fra-equ01
00000000-0000-0000-0000-ac1f6b7bed26      Phoned Home     49s                                                                                        c1-xlarge-x86                                         fra-equ01
00000000-0000-0000-0000-ac1f6b7b77e4      Phoned Home     4s       1d 4h     shoot--p9sk4...-firewall-5b3b7  7b29e8ea-e4c8-4aaa-9e42-70dd39d20108    s1-large-x86          Firewall 2 Ubuntu 20210606      fra-equ01
00000000-0000-0000-0000-ac1f6b7bed30      Phoned Home     4s       105d 2h   shoot--test-...ker-5f9b5-ltk9g  00000000-0000-0000-0000-000000000001    c1-xlarge-x86         Ubuntu 20.04 20210316           fra-equ01
00000000-0000-0000-0000-ac1f6bd3909c      Phoned Home     4s       113d 31m  storage-firewall                a0a4c959-b191-4b4d-8483-951ccc2ff3f1    c1-large-x86          Firewall 2 Ubuntu 20210316      fra-equ01
00000000-0000-0000-0000-ac1f6b7beb80      Phoned Home     5s       1d 16h    shoot--p5c7f...p-0-5968d-gtk95  5410a72d-14c1-424e-9896-71c7ee84d393    c1-xlarge-x86         Debian 10 20210719              fra-equ01
00000000-0000-0000-0000-ac1f6b7d7dc6      Phoned Home     4s       105d 2h   shoot--phjjb...p-0-77fc5-k5wp6  5820c4e7-fbd4-4e4b-a40b-2b83eb34bbe1    s2-xlarge-x86         Debian 10 20210519              fra-equ01
256b1c00-be6d-11e9-8000-3cecef22b288      Phoned Home     5s       8d 1h     shoot--p5c7f...-firewall-9c9af  5410a72d-14c1-424e-9896-71c7ee84d393    n1-medium-x86         Firewall 2 Ubuntu 20210606      fra-equ01
6f440a00-be4d-11e9-8000-3cecef22f91c      Phoned Home     4s       6d 42m    shoot--pskqm...-firewall-44522  b5f26a3b-9a4d-48db-a6b3-d1dd4ac4abec    n1-medium-x86         Firewall 2 Ubuntu 20201214      fra-equ01
00000000-0000-0000-0000-ac1f6bd39026      Waiting         56s                                                                                        c1-large-x86                                          fra-equ01
00000000-0000-0000-0000-ac1f6bd390b2      Phoned Home     4s       1d 14h    shoot--p5c7f...p-0-b5f87-pjpk2  5410a72d-14c1-424e-9896-71c7ee84d393    c1-large-x86          Debian 10 20210719              fra-equ01</code></pre></li></ul><h3 id="Custom-Role-Permissions"><a class="docs-heading-anchor" href="#Custom-Role-Permissions">Custom Role Permissions</a><a id="Custom-Role-Permissions-1"></a><a class="docs-heading-anchor-permalink" href="#Custom-Role-Permissions" title="Permalink"></a></h3><p>A user creates a custom role <code>ci-builder</code> and a project token for it:</p><ul><li><p>The user has permissions to create a role.</p><pre><code class="language-none">$ metalctl show-permissions
Project: 793bb6cd-8b46-479d-9209-0fedca428fe1
Roles:
  metal-stack-user
  metal-stack-project-owner
Permissions:
  metal.v2.role.list
  metal.v2.role.get
  metal.v2.role.create
  metal.v2.role.update
  metal.v2.role.delete
  metal.v2.project.token-list
  metal.v2.project.token-get
  metal.v2.project.token-create
  metal.v2.project.token-revoke
  ...more typical user permissions...
Resources:
  *</code></pre></li><li><p>A user can create a custom role for the project. He can&#39;t elevate his permissions and can only create roles with permissions the user owns.</p><pre><code class="language-none">$ metalctl role create --name ci-builder --permissions metal.v2.machine.get,metal.v2.machine.create,metal.v2.machine.delete</code></pre></li><li><p>The user can create the project token.</p><pre><code class="language-none">$ metalctl project token create --role ci-builder
&lt;token&gt;</code></pre></li><li><p>This token can now be used for login, too.</p><pre><code class="language-none">$ metalctl login --project-token &lt;token&gt;</code></pre></li><li><p>The project token has restricted permissions.</p><pre><code class="language-none">$ metalctl whoami
UserId: gerrit
Email: gerrit@gerrit.gerrit
Tenant: my-tenant
Issuer: https://dex.test.io/dex
Expires at Thu Jul 22 00:07:09 CEST 2021

$ metalctl show-permissions
Project: 793bb6cd-8b46-479d-9209-0fedca428fe1
Roles:
  ci-builder
Permissions:
  metal.v2.machine.get
  metal.v2.machine.create
  metal.v2.machine.delete
Resources:
  *</code></pre></li></ul><p>General question: Should there be a <code>masterdatactl</code> (something like an extension of <code>metalctl</code>) to maintain tenants, projects, quotas, users, roles and accounting details?</p><h2 id="Centralized-vs.-Decentralized-User-Management"><a class="docs-heading-anchor" href="#Centralized-vs.-Decentralized-User-Management">Centralized vs. Decentralized User Management</a><a id="Centralized-vs.-Decentralized-User-Management-1"></a><a class="docs-heading-anchor-permalink" href="#Centralized-vs.-Decentralized-User-Management" title="Permalink"></a></h2><ul><li>TBD (Dex, Keycloak, User Management)</li><li>Initial user workflow</li><li>Connect to external user management?</li></ul><p>Advantages of Centralized:</p><ul><li>Much easier to adopt</li><li>More developer-friendly</li><li>Better to unit test</li></ul><p>Advantages of Decentralized:</p><ul><li>Compliance (regulatory compliance)</li></ul><h3 id="Global-and-User-Scopes-for-Resources"><a class="docs-heading-anchor" href="#Global-and-User-Scopes-for-Resources">Global &amp; User Scopes for Resources</a><a id="Global-and-User-Scopes-for-Resources-1"></a><a class="docs-heading-anchor-permalink" href="#Global-and-User-Scopes-for-Resources" title="Permalink"></a></h3><p>The admins / operators of the metal-stack should be able to provide &quot;global&quot; resources that users are able to use. This means, that users can view and use these resources, but they are not allowed to create, modify or delete them.</p><div class="admonition is-info"><header class="admonition-header">Info</header><div class="admonition-body"><p>When a project ID is empty on a resource, the resource is considered &quot;global&quot;.</p></div></div><p>Where possible, users should be capable of creating their own resource entities.</p><table><tr><th style="text-align: left">Resource</th><th style="text-align: left">User</th><th style="text-align: left">Global</th></tr><tr><td style="text-align: left">File System Layout</td><td style="text-align: left">yes</td><td style="text-align: left">yes</td></tr><tr><td style="text-align: left">Firewall</td><td style="text-align: left">yes</td><td style="text-align: left"></td></tr><tr><td style="text-align: left">Firmware</td><td style="text-align: left"></td><td style="text-align: left">yes</td></tr><tr><td style="text-align: left">OS Image</td><td style="text-align: left">yes</td><td style="text-align: left">yes</td></tr><tr><td style="text-align: left">Machine</td><td style="text-align: left">yes</td><td style="text-align: left"></td></tr><tr><td style="text-align: left">Network (Base)</td><td style="text-align: left"></td><td style="text-align: left">yes</td></tr><tr><td style="text-align: left">Network (Children)</td><td style="text-align: left">yes</td><td style="text-align: left"></td></tr><tr><td style="text-align: left">IP</td><td style="text-align: left">yes</td><td style="text-align: left"></td></tr><tr><td style="text-align: left">Partition</td><td style="text-align: left"></td><td style="text-align: left">yes</td></tr><tr><td style="text-align: left">Project</td><td style="text-align: left">yes</td><td style="text-align: left"></td></tr><tr><td style="text-align: left">Size</td><td style="text-align: left"></td><td style="text-align: left">yes</td></tr><tr><td style="text-align: left">Switch</td><td style="text-align: left"></td><td style="text-align: left">yes</td></tr></table><div class="admonition is-info"><header class="admonition-header">Info</header><div class="admonition-body"><p>A user can make use of the file system layouts provided by the admins, but can also create own layouts. Same applies for images. As soon as a user creates own resources, the user takes over the responsibility for the machine provisioning to succeed.</p></div></div><h3 id="Auditing"><a class="docs-heading-anchor" href="#Auditing">Auditing</a><a id="Auditing-1"></a><a class="docs-heading-anchor-permalink" href="#Auditing" title="Permalink"></a></h3><p>With the new API we also have the chance of introducing API auditing throughout the resources.</p><p>The auditing can be configured with different emitters, like:</p><ul><li>Rethinkdb (can be accessed through <code>metalctl audit ls</code>)</li><li>Splunk</li><li>Elasticsearch</li><li>...</li></ul><p>And contain:</p><ul><li>User information (name, mail)</li><li>Requested endpoint path</li><li>Permissions</li><li>OPA decision</li><li>Status code</li></ul><h2 id="Implementation"><a class="docs-heading-anchor" href="#Implementation">Implementation</a><a id="Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation" title="Permalink"></a></h2><ul><li>Introducing API V2</li><li>Introducing OPA</li><li>Common filter queries for all resources</li></ul><h3 id="API-v2"><a class="docs-heading-anchor" href="#API-v2">API v2</a><a id="API-v2-1"></a><a class="docs-heading-anchor-permalink" href="#API-v2" title="Permalink"></a></h3><p>We will need an API v2, which gives all components and users time to slowly change to the new API while maintaining the current functionality of the endpoints in the metal-api.</p><ul><li>Introduce new paths that allow decisions about access very early in the game (only from endpoint and the user permissions)</li><li>Get rid off layer HMAC auth (replaced by project tokens)</li><li>Move internal endpoints to gRPC (e.g. register machine), remove daisy-chained swagger client from metal-core</li><li>Remove request wrapper structs from metal-go (https://github.com/metal-stack/metal-go/issues/33)</li></ul><p>We can start working on this for every resource individually. The work will potentially turn into a new shared layer with common functionality between v1/v2 (e.g. code for machine creation) with the API-specific packages only becoming responsible for mapping requests.</p><h3 id="Resource-Paths"><a class="docs-heading-anchor" href="#Resource-Paths">Resource Paths</a><a id="Resource-Paths-1"></a><a class="docs-heading-anchor-permalink" href="#Resource-Paths" title="Permalink"></a></h3><p>Suggested convention for path layout: <code>/:api-version/:resource/:id[/&lt;operation&gt;][?project-id=:projectid]</code></p><p>The project ID has to become part of the path layout because extracting the project from the request payload is hard to achieve.</p><p>In order to create the input for OPA, we need a call to the backend on the user name + project ID. The response contains the permissions and resources on this project.</p><h4 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h4><p>Let&#39;s imagine a user issuing the following request:</p><pre><code class="language-none">metalctl machine describe 00000000-0000-0000-0000-ac1f6b7befb2</code></pre><p>This will call <code>GET /v2/machine/00000000-0000-0000-0000-ac1f6b7befb2?project-id=my-project</code>.</p><p>Here is an example rule set for OPA (you can try it on the <a href="https://play.openpolicyagent.org/">rego playground</a>):</p><pre><code class="language-none">package api.v2.metalstack.io.authz

permissions = {
    &quot;metal.v2.machine.get&quot;
}

default decision = {&quot;allow&quot;: false}

match(e) {
    glob.match(input.backend.permissions, [&quot;,&quot;], e)
}

decision = {&quot;allow&quot;: true} {
	match(e.permission)
	input.request.project != &quot;&quot;
}

decision = {&quot;allow&quot;: true} {
	match(e.permission)
    input.backend.admin
	input.request.project == &quot;&quot;
}

decision = {&quot;allow&quot;: false, &quot;reason&quot;: reason} {
	not match(e.permission)
	reason := sprintf(&quot;missing permission on %s&quot;, [e.permission])
}

decision = {&quot;allow&quot;: false, &quot;reason&quot;: reason} {
    not input.backend.admin
	input.request.project == &quot;&quot;
	reason := &quot;global resource access required admin rights&quot;
}


e = {&quot;permission&quot;: permissions[&quot;metal.v2.machine.get&quot;]} {
 	some id
	input.request.method = &quot;GET&quot;
	input.request.path = [&quot;v2&quot;, &quot;machine&quot;, id]
    glob.match(input.backend.resources, [&quot;,&quot;], id)
}</code></pre><p>OPA input:</p><pre><code class="language-json">{
  &quot;token&quot;: {
    &quot;user&quot;: &quot;gerrit&quot;,
    &quot;tenant&quot;: &quot;my-tenant&quot;
  },
  &quot;request&quot;: {
    &quot;method&quot;: &quot;GET&quot;,                                                   // from request
    &quot;path&quot;: [&quot;v2&quot;, &quot;machine&quot;, &quot;00000000-0000-0000-0000-ac1f6b7befb2&quot;], // split on request path
    &quot;project&quot;: &quot;my-project&quot;                                            // from request query param
  },
  &quot;backend&quot;: { // composed from role permissions of the project-id from query param, formed to a glob matching pattern
    &quot;permissions&quot;: &quot;{metal.v2.machine.list,metal.v2.machine.get,metal.v2.machine.create,metal.v2.machine.update,metal.v2.machine.delete}&quot;,
    &quot;resources&quot;: &quot;{*}&quot;,
    &quot;admin: false
  }
}</code></pre><p>OPA output:</p><pre><code class="language-json">{
    &quot;decision&quot;: {
        &quot;allow&quot;: true
    },
    &quot;e&quot;: {
        &quot;permission&quot;: &quot;metal.v2.machine.get&quot;
    },
    &quot;permissions&quot;: [
        &quot;metal.v2.machine.get&quot;
    ]
}</code></pre><h3 id="Permission-Wildcards"><a class="docs-heading-anchor" href="#Permission-Wildcards">Permission Wildcards</a><a id="Permission-Wildcards-1"></a><a class="docs-heading-anchor-permalink" href="#Permission-Wildcards" title="Permalink"></a></h3><p>Permissions should be able to match wildcards.</p><p>Example for admin user:</p><pre><code class="language-none">$ metalctl project show-permissions
Roles:
  metal-stack-project-owner
Permissions:
  metal.v2.*
Resources:
  *</code></pre><h3 id="Scoping"><a class="docs-heading-anchor" href="#Scoping">Scoping</a><a id="Scoping-1"></a><a class="docs-heading-anchor-permalink" href="#Scoping" title="Permalink"></a></h3><p>We want a common scoping logic on the database for all resources. Therefore, all resources must use the same database fields that can be used for filtering.</p><table><tr><th style="text-align: right">Scope</th><th style="text-align: right">Field Name</th></tr><tr><td style="text-align: right">Tenant</td><td style="text-align: right">tenant_id</td></tr><tr><td style="text-align: right">Project</td><td style="text-align: right">project_id</td></tr><tr><td style="text-align: right">Resource</td><td style="text-align: right">id</td></tr></table><h2 id="Migration-Path"><a class="docs-heading-anchor" href="#Migration-Path">Migration Path</a><a id="Migration-Path-1"></a><a class="docs-heading-anchor-permalink" href="#Migration-Path" title="Permalink"></a></h2><h3 id="Migrate-Existing-Gardener-Projects-to-New-API"><a class="docs-heading-anchor" href="#Migrate-Existing-Gardener-Projects-to-New-API">Migrate Existing Gardener Projects to New API</a><a id="Migrate-Existing-Gardener-Projects-to-New-API-1"></a><a class="docs-heading-anchor-permalink" href="#Migrate-Existing-Gardener-Projects-to-New-API" title="Permalink"></a></h3><ul><li>Do not point the secret bindings to a the shared provider secret in a partition. Create an individual provider-secret for the logged in tenant. The Gardener needs to use this tenant-specific provider secret to talk to the metal-api, do not give the Gardener HMAC access anymore.</li><li>The provider secret partition mapping can be removed from the cloud-api config and from the deployment</li></ul></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Thursday 22 July 2021 11:27">Thursday 22 July 2021</span>. Using Julia version 1.6.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
