<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>No Open Ports To the Data Center · metal-stack</title><meta name="title" content="No Open Ports To the Data Center · metal-stack"/><meta property="og:title" content="No Open Ports To the Data Center · metal-stack"/><meta property="twitter:title" content="No Open Ports To the Data Center · metal-stack"/><meta name="description" content="Documentation for metal-stack."/><meta property="og:description" content="Documentation for metal-stack."/><meta property="twitter:description" content="Documentation for metal-stack."/><meta property="og:url" content="https://docs.metal-stack.io/development/proposals/MEP9/README/"/><meta property="twitter:url" content="https://docs.metal-stack.io/development/proposals/MEP9/README/"/><link rel="canonical" href="https://docs.metal-stack.io/development/proposals/MEP9/README/"/><script data-outdated-warner src="../../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../search_index.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script><link href="../../../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../../../assets/youtube.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="metal-stack logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../../">metal-stack</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Introduction</a></li><li><span class="tocitem">Overview</span><ul><li><a class="tocitem" href="../../../../overview/architecture/">Architecture</a></li><li><a class="tocitem" href="../../../../overview/networking/">Networking</a></li><li><a class="tocitem" href="../../../../overview/hardware/">Hardware Support</a></li><li><a class="tocitem" href="../../../../overview/os/">Operating Systems</a></li><li><a class="tocitem" href="../../../../overview/kubernetes/">Kubernetes Integration</a></li><li><a class="tocitem" href="../../../../overview/isolated-kubernetes/">Isolated Kubernetes</a></li><li><a class="tocitem" href="../../../../overview/gpu-support/">GPU Support</a></li><li><a class="tocitem" href="../../../../overview/storage/">Storage</a></li><li><a class="tocitem" href="../../../../overview/comparison/">Comparison</a></li></ul></li><li><a class="tocitem" href="../../../../quickstart/">Quickstart</a></li><li><span class="tocitem">Installation &amp; Administration</span><ul><li><a class="tocitem" href="../../../../installation/deployment/">Installation</a></li><li><a class="tocitem" href="../../../../installation/updates/">Releases and Updates</a></li><li><a class="tocitem" href="../../../../installation/monitoring/">Monitoring</a></li><li><a class="tocitem" href="../../../../installation/troubleshoot/">Troubleshoot</a></li></ul></li><li><span class="tocitem">User Guides</span><ul><li><a class="tocitem" href="../../../../external/mini-lab/README/">mini-lab</a></li><li><a class="tocitem" href="../../../../external/metalctl/README/">metalctl</a></li><li><a class="tocitem" href="../../../../external/csi-driver-lvm/README/">csi-driver-lvm</a></li><li><a class="tocitem" href="../../../../external/firewall-controller/README/">firewall-controller</a></li></ul></li><li><a class="tocitem" href="../../../../apidocs/apidocs/">API Documentation</a></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../../../client_libraries/">Client Libraries</a></li><li><a class="tocitem" href="../../../roadmap/">Roadmap</a></li><li><a class="tocitem" href="../../">Enhancement Proposals</a></li><li><a class="tocitem" href="../../../contributing/">Contributing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>No Open Ports To the Data Center</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>No Open Ports To the Data Center</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/metal-stack/docs.git" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="github.com/metal-stack/docs.git" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="No-Open-Ports-To-the-Data-Center"><a class="docs-heading-anchor" href="#No-Open-Ports-To-the-Data-Center">No Open Ports To the Data Center</a><a id="No-Open-Ports-To-the-Data-Center-1"></a><a class="docs-heading-anchor-permalink" href="#No-Open-Ports-To-the-Data-Center" title="Permalink"></a></h1><p>Our metal-stack partitions typically have open ports for metal-stack native services, these are:</p><ul><li>SSH port on the firewalls</li><li>bmc-reverse-proxy for serial console access through the metal-console</li></ul><p>These open ports are potential security risks. For example, while SSH access is possible only with private key it&#39;s still vulnerable to DoS attack.</p><p>Therefore, we want to get rid off these open ports to reduce the attack surface to the data center.</p><h2 id="Requirements"><a class="docs-heading-anchor" href="#Requirements">Requirements</a><a id="Requirements-1"></a><a class="docs-heading-anchor-permalink" href="#Requirements" title="Permalink"></a></h2><ul><li>Access to firewall SSH only via VPN</li><li>Easy to update VPN components</li></ul><p>As a next step, we can also consider joining the management servers to the VPN mesh, which would replace typical WireGuard setups for operators to enter resources inside the partition.</p><h2 id="High-Level-Design"><a class="docs-heading-anchor" href="#High-Level-Design">High Level Design</a><a id="High-Level-Design-1"></a><a class="docs-heading-anchor-permalink" href="#High-Level-Design" title="Permalink"></a></h2><p><a href="../architecture.drawio.svg"></a></p><blockquote><p>Simplified drawing showing old vs. new architecture.</p></blockquote><h3 id="Concerns"><a class="docs-heading-anchor" href="#Concerns">Concerns</a><a id="Concerns-1"></a><a class="docs-heading-anchor-permalink" href="#Concerns" title="Permalink"></a></h3><p>There&#39;s few concerns when using WireGuard for implementing VPN:</p><ol><li>WireGuard doesn&#39;t implement dynamic cipher substitution. Which is important in case one of the crypto methods, used by WireGuard will be broken. The only possible solution for that will be to update WireGuard to a fixed version.</li><li>Coordination server(Headscale) is a single point of failure. In case it fails, it potentially can disconnect existing members of the network, as WireGuard can&#39;t manage dynamic IPs by itself.</li><li>Headscale is already falls behind Tailscale coordination server implementation. Which can complicate the upgrade to newer version of Tailscale client in case of emergency.</li></ol><h3 id="Solutions-to-concerns"><a class="docs-heading-anchor" href="#Solutions-to-concerns">Solutions to concerns</a><a id="Solutions-to-concerns-1"></a><a class="docs-heading-anchor-permalink" href="#Solutions-to-concerns" title="Permalink"></a></h3><ol><li>Tailscale node software is using userspace implementation of WireGuard – <code>wireguard-go</code>. One of the options is to inject Tailscale client into <code>metalctl</code>. And make it available as <code>metalctl vpn</code> or similar command. It should be possible to do as <code>tailscale</code> node is already available as open sourced Go pkg. That would allow us to control, what version of Tailscale users are using and in case of any critical changes to enforce them to update <code>metalctl</code> to use VPN functionality.</li><li>Would it be a considerable risk? We could look into <code>wg-dynamic</code> project to cover this problem.</li><li>At the moment, repository looks well maintained and the metal-stack team already contributes to it.</li></ol><h2 id="Implementation-Details"><a class="docs-heading-anchor" href="#Implementation-Details">Implementation Details</a><a id="Implementation-Details-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation-Details" title="Permalink"></a></h2><h3 id="metal-roles"><a class="docs-heading-anchor" href="#metal-roles">metal-roles</a><a id="metal-roles-1"></a><a class="docs-heading-anchor-permalink" href="#metal-roles" title="Permalink"></a></h3><p><code>metal-roles</code> will be responsible for deployment of <code>headscale</code> server(via new <code>headscale</code> role). It also should provide sufficient config to <code>metal-api</code> so it establishes connection with <code>headscale</code> gRPC server.</p><h3 id="New-metalctl-commands"><a class="docs-heading-anchor" href="#New-metalctl-commands">New <code>metalctl</code> commands</a><a id="New-metalctl-commands-1"></a><a class="docs-heading-anchor-permalink" href="#New-metalctl-commands" title="Permalink"></a></h3><p><code>metalctl</code> will be responsible for client-side implementation of this MEP. Specifically, it&#39;s by using <code>metalctl</code> user expected to connect to firewalls.</p><ul><li><code>metalctl vpn</code> – section for VPN related commands:<ul><li><code>metalctl vpn get key [vpn name] --namespace [namespace name]</code> – returns auth key to be used with <code>tailscale</code> client for establishing connection.</li></ul></li></ul><p>Extend <code>metalctl firewall</code>:</p><ul><li><code>metalctl firewall ssh [ID]</code> – connect to firewall via SSH.</li></ul><p>Extend <code>metalctl machine</code>:</p><ul><li><code>metalctl machine ssh [ID]</code> – connect to machine via SSH.</li></ul><p><code>metalctl</code> will be able to connect to firewall and machines by running <code>tailscale</code> in container.</p><h3 id="metal-api"><a class="docs-heading-anchor" href="#metal-api">metal-api</a><a id="metal-api-1"></a><a class="docs-heading-anchor-permalink" href="#metal-api" title="Permalink"></a></h3><p>Updates to <code>metal-api</code> should be made, so that it&#39;s able to add firewalls to VPNs. There should be one Tailscale namespace per project. So if multiple firewalls are created in single project, they will join the same namespace.</p><p>Two new flags should be introduced to connect <code>metal-api</code> to <code>headscale</code> gRPC server:</p><ul><li><code>headscale-addr</code> – specifies address of Headscale grpc API.</li><li><code>headscale-api-key</code> – specifies temporary API key to connect to Headscale. It should be replaced and then rotated by <code>metal-api</code>.</li></ul><p>If <code>metal-api</code> initialized with <code>headscale</code> connection it should automatically join all created firewalls to VPN.</p><p>Add new endpoint, that will be used by <code>metalctl</code> to connect to VPN:</p><ul><li><code>/v1/vpn GET</code> – requests auth key from <code>headscale</code> server.</li></ul><h3 id="metal-hammer"><a class="docs-heading-anchor" href="#metal-hammer">metal-hammer</a><a id="metal-hammer-1"></a><a class="docs-heading-anchor-permalink" href="#metal-hammer" title="Permalink"></a></h3><p><code>metal-hammer</code> acts as an intermediary for machine configuration between <code>metal-api</code> and machine&#39;s image. Specifically it writes to <code>/etc/metal/install.yaml</code> file, data from which later will be used by image&#39;s <code>install.sh</code> file.</p><p>To implement VPN support we have to add authentication key and VPN server address to <code>install.yaml</code> file. This key will be used to join machine to a VPN.</p><h3 id="metal-images"><a class="docs-heading-anchor" href="#metal-images">metal-images</a><a id="metal-images-1"></a><a class="docs-heading-anchor-permalink" href="#metal-images" title="Permalink"></a></h3><p>Images <code>install.sh</code> script have to be updated to work with authentication key and VPN server address, provided in <code>install.yaml</code> file. If this key is present, machine should connect to VPN.</p><h3 id="metal-networker"><a class="docs-heading-anchor" href="#metal-networker">metal-networker</a><a id="metal-networker-1"></a><a class="docs-heading-anchor-permalink" href="#metal-networker" title="Permalink"></a></h3><p><code>metal-networker</code> also have to know if VPN was configured. In that case we need to disable public access to SSH and allow all(?) traffic from WireGuard interface.</p><h3 id="firewall-controller"><a class="docs-heading-anchor" href="#firewall-controller">firewall-controller</a><a id="firewall-controller-1"></a><a class="docs-heading-anchor-permalink" href="#firewall-controller" title="Permalink"></a></h3><p><code>firewall-controller</code> have to monitor changes in <code>Firewall</code> resource and keep <code>tailscaled</code> version up-to-date.</p><h3 id="Resources"><a class="docs-heading-anchor" href="#Resources">Resources</a><a id="Resources-1"></a><a class="docs-heading-anchor-permalink" href="#Resources" title="Permalink"></a></h3><p>Update <code>Firewall</code> resource to include desired/actual <code>tailscale</code> version:</p><pre><code class="nohighlight hljs">Firewall:
  Spec:
    tailscale:
      Version:   Minimal version
    ...
  Status:
    ...
    VPN:
      Status:    Boolean field
    tailscale:
      Version:   Actual version
    ...</code></pre><h3 id="bmc-reverse-proxy"><a class="docs-heading-anchor" href="#bmc-reverse-proxy">bmc-reverse-proxy</a><a id="bmc-reverse-proxy-1"></a><a class="docs-heading-anchor-permalink" href="#bmc-reverse-proxy" title="Permalink"></a></h3><p>TODO</p><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><ol><li><a href="https://www.youtube.com/watch?v=88GyLoZbDNw">WireGuard: Next Generation Secure Network Tunnel</a></li><li><a href="https://tailscale.com/blog/how-tailscale-works">How Tailscale works</a></li><li><a href="https://tailscale.com/blog/soc2">Tailscale is officially SOC 2 compliant</a></li><li><a href="https://www.ipfire.org/blog/why-not-wireguard">Why not Wireguard</a></li><li><a href="https://www.wireguard.com/known-limitations/">Wireguard: Known Limitations</a></li><li><a href="https://www.wireguard.com/todo/">Wireguard: Things That Might Be Accomplished</a></li><li><a href="https://github.com/juanfont/headscale/issues/526">Headscale: Tailscale control protocol v2</a></li></ol></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Thursday 23 January 2025 13:44">Thursday 23 January 2025</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
