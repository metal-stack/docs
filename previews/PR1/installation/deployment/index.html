<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Installation · metal-stack</title><link rel="canonical" href="https://metal-stack.github.io/docs/master/installation/deployment/"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../assets/youtube.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="metal-stack logo"/></a><div class="docs-package-name"><span class="docs-autofit">metal-stack</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><span class="tocitem">Overview</span><ul><li><a class="tocitem" href="../../overview/architecture/">Architecture</a></li><li><a class="tocitem" href="../../overview/networking/">Networking</a></li><li><a class="tocitem" href="../../overview/hardware/">Hardware Support</a></li><li><a class="tocitem" href="../../overview/os/">Operating Systems</a></li><li><a class="tocitem" href="../../overview/kubernetes/">Kubernetes Integration</a></li></ul></li><li><a class="tocitem" href="../../quickstart/">Quickstart</a></li><li><span class="tocitem">Installation &amp; Maintenance</span><ul><li class="is-active"><a class="tocitem" href>Installation</a><ul class="internal"><li><a class="tocitem" href="#Metal-Control-Plane-Deployment-1"><span>Metal Control Plane Deployment</span></a></li><li><a class="tocitem" href="#Bootstrapping-a-Partition-1"><span>Bootstrapping a Partition</span></a></li><li><a class="tocitem" href="#Partition-Deployment-1"><span>Partition Deployment</span></a></li><li><a class="tocitem" href="#Gardener-with-metal-stack-1"><span>Gardener with metal-stack</span></a></li></ul></li><li><a class="tocitem" href="../monitoring/">Monitoring</a></li><li><a class="tocitem" href="../troubleshoot/">Troubleshoot</a></li></ul></li><li><span class="tocitem">User Guides</span><ul><li><a class="tocitem" href="../../external/mini-lab/README/">mini-lab</a></li><li><a class="tocitem" href="../../external/metalctl/README/">metalctl</a></li><li><a class="tocitem" href="../../external/csi-lvm/README/">csi-lvm</a></li><li><a class="tocitem" href="../../external/firewall-controller/README/">firewall-controller</a></li></ul></li><li><a class="tocitem" href="../../api_docs/">API Documentation</a></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../../roadmap/">Roadmap</a></li><li><a class="tocitem" href="../../proposals/">Enhancement Proposals</a></li><li><a class="tocitem" href="../../contributing/">Contributing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Installation &amp; Maintenance</a></li><li class="is-active"><a href>Installation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Installation</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/metal-stack/docs/blob/master/docs/src/installation/deployment.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Deploying-metal-stack-1"><a class="docs-heading-anchor" href="#Deploying-metal-stack-1">Deploying metal-stack</a><a class="docs-heading-anchor-permalink" href="#Deploying-metal-stack-1" title="Permalink"></a></h1><p>We are bootstrapping the <a href="../../overview/architecture/##Metal-Control-Plane-1">metal control plane</a> as well as our <a href="../../overview/architecture/#Partitions-1">partitions</a> with <a href="https://www.ansible.com/">Ansible</a> through CI.</p><p>In order to build up your deployment, you can make use of the Ansible roles that we are using by ourselves in order to deploy the metal-stack. You can find them in the repository called <a href="https://github.com/metal-stack/metal-roles">metal-roles</a>. In order to wrap all deployment dependencies there is a special <a href="https://hub.docker.com/r/metalstack/metal-deployment-base">deployment base image</a> on Docker Hub that you can use. Using this Docker image eliminates a lot of moving parts in the deployment and should keep the footprints on your system fairly small and maintainable.</p><p>This document will from now on assume that you want to use our Ansible deployment roles for setting up metal-stack. We will also use the deployment base image, so you should also have <a href="https://docs.docker.com/get-docker/">Docker</a> installed.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Probably you need to learn writing Ansible playbooks if you want to be able to deploy the metal-stack as presented in this documentation. Even when starting without any knowledge about Ansible it should not be too hard to follow these docs. In case you need further explanations regarding Ansible please refer to <a href="https://docs.ansible.com/">docs.ansible.com</a>.</p></div></div><div class="admonition is-info"><header class="admonition-header">Info</header><div class="admonition-body"><p>If you do not want to use Ansible for deployment, you need to come up with a deployment mechanism by yourself. However, you will probably be able to re-use some of our contents from our <a href="https://github.com/metal-stack/metal-roles">metal-roles</a> repository, e.g. the Helm chart for deploying the metal control plane.</p></div></div><h2 id="Metal-Control-Plane-Deployment-1"><a class="docs-heading-anchor" href="#Metal-Control-Plane-Deployment-1">Metal Control Plane Deployment</a><a class="docs-heading-anchor-permalink" href="#Metal-Control-Plane-Deployment-1" title="Permalink"></a></h2><p>The metal control plane is typically deployed in a Kubernetes cluster. Therefore, this document will assume that you have a Kubernetes cluster ready for application deployment. However, there are no specific dependencies for metal-stack running in a Kubernetes cluster. </p><div class="admonition is-success"><header class="admonition-header">Tip</header><div class="admonition-body"><p>It is not a requirement to run Kubernetes in your own data center. You can use a cluster managed by a hyperscaler. This has the advantage that you do not need to setup a Kubernetes cluster by yourself and could even become beneficial if you want to improve on fail-safe operation. The only requirement from metal-stack is that your partitions can establish network connections to the metal control plane.</p></div></div><p>Let&#39;s start off with a fresh folder for a new git repository in order to start with your deployment:</p><pre><code class="language-bash">mkdir -p metal-stack-deployment
cd metal-stack-deployment
git init</code></pre><p>Let&#39;s now create the following files and folder structures:</p><pre><code class="language-none">.
├── ansible.cfg
├── deploy_metal_control_plane.yaml
├── group_vars
│   └── control-plane
│       └── all.yaml
├── inventory.yaml
├── requirements.yaml
└── roles
    └── ingress-controller
        └── tasks
            └── main.yaml</code></pre><div class="admonition is-success"><header class="admonition-header">Tip</header><div class="admonition-body"><p>You can also use the <a href="https://github.com/metal-stack/mini-lab">mini-lab</a> as a template project for your deployment. It uses the same mechanisms mentioned in this document.</p></div></div><p>The <code>requirements.yaml</code> is used for declaring <a href="https://galaxy.ansible.com/">Ansible Galaxy</a> role depedencies. It will dynamically provide <a href="https://github.com/metal-stack/metal-roles">metal-roles</a> and the <a href="https://github.com/metal-stack/ansible-common">ansible-common</a> role when starting the deployment. The file should contain the following dependencies:</p><pre><code class="language-yaml">---
- src: https://github.com/metal-stack/ansible-common.git
  name: ansible-common
  version: v0.5.2
- src: https://github.com/metal-stack/metal-roles.git
  name: metal-roles
  version: v0.1.12</code></pre><div class="admonition is-success"><header class="admonition-header">Tip</header><div class="admonition-body"><p>The <a href="https://github.com/metal-stack/ansible-common.git">ansible-common</a> repository contains very general roles that you can also use when extending your deployment further.</p></div></div><p>Then, there will be an inventory in the <code>inventory.yaml</code> that adds the localhost to the <code>control-plane</code> host group:</p><pre><code class="language-yaml">---
control-plane:
  hosts:
    localhost:
      ansible_python_interpreter: &quot;{{ ansible_playbook_python }}&quot;</code></pre><p>We do this since we are deploying to Kubernetes and do not need to SSH-connect to any hosts for deployment (which is what Ansible typically does). This inventory is also necessary to pick up the variables inside <code>group_vars/control-plane</code> during the deployment.</p><p>We also recommend using the following <code>ansible.cfg</code>:</p><pre><code class="language-ini">[defaults]
retry_files_enabled = false
force_color = true
host_key_checking = false
stdout_callback = yaml
jinja2_native = true
transport = ssh
timeout = 30</code></pre><p>Most of the properties in there are up to taste, but make sure you enable the <a href="https://jinja.palletsprojects.com/en/2.11.x/nativetypes/">Jinja2 native environment</a> as this is needed for some of our roles.</p><p>Next, we will define the first playbook in a file called <code>deploy_metal_control_plane.yaml</code>. You can start with the following lines:</p><pre><code class="language-yaml">---
- name: Deploy Control Plane
  hosts: control-plane
  connection: local
  gather_facts: no
  roles:
    - name: ansible-common
      tags: always
    - name: ingress-controller
      tags: ingress-controller
    - name: metal-roles/control-plane/roles/prepare
      tags: prepare
    - name: metal-roles/control-plane/roles/nsq
      tags: nsq
    - name: metal-roles/control-plane/roles/metal-db
      tags: metal-db
    - name: metal-roles/control-plane/roles/ipam-db
      tags: ipam-db
    - name: metal-roles/control-plane/roles/masterdata-db
      tags: masterdata-db
    - name: metal-roles/control-plane/roles/metal
      tags: metal</code></pre><p>The parametrization of the referenced roles can be looked up in more detail in the role documention on <a href="https://github.com/metal-stack/metal-roles/tree/master/control-plane">metal-roles/control-plane</a>. You should not need much special parametrization for now. Just make sure you define all the variables marked as &quot;required&quot; in your <code>group_vars/control-plane/all.yaml</code>:</p><pre><code class="language-yaml">---
# common defaults
metal_control_plane_provider_tenant: acme
metal_control_plane_ingress_dns: &lt;your-dns-domain&gt;
metal_control_plane_stage_name: test

# image versions
metal_api_image_tag: v0.7.5
metal_metalctl_image_tag: v0.7.5
metal_masterdata_api_image_tag: v0.7.1
metal_console_image_tag: v0.4.1

metal_db_backup_restore_sidecar_image_tag: v0.5.1
ipam_db_backup_restore_sidecar_image_tag: v0.5.1
masterdata_db_backup_restore_sidecar_image_tag: v0.5.1</code></pre><p>By the time you will certainly add more parametrization to the deployment. Feel free to split up your <code>all.yaml</code> into separate files to keep everything short and clean.</p><p>TODO: Describe dealing with grpc certs and certs for NSQ...</p><p>As a next step you will need add the tasks for deploying an ingress-controller into your cluster. <a href="https://kubernetes.github.io/ingress-nginx/">nginx-ingress</a> is what we use. If you want to use another ingress-controller, you need to parametrize the metal roles carefully. When you just use nginx-ingress, make sure to also deploy it to the default namespace ingress-nginx.</p><p>TODO: Add deployment via helm chart</p><p>Now, it should be possible to run the deployment through Docker. Make sure to have the <a href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/">Kubeconfig file</a> of your cluster for Ansible and set the path in the following command accordingly:</p><pre><code class="language-bash">export KUBECONFIG=&lt;path-to-your-cluster-kubeconfig&gt;
docker run --rm -it \
  -v $(pwd):/workdir \
  --workdir /workdir \
  -e KUBECONFIG=&quot;${KUBECONFIG}&quot; \
  -e K8S_AUTH_KUBECONFIG=&quot;${KUBECONFIG}&quot; \
  metalstack/metal-deployment-base:v0.0.5 \
  /bin/bash -ce \
    &quot;ansible-galaxy install -r requirements.yaml
    ansible-playbook \
      -i inventory.yaml \
      deploy_metal_control_plane.yaml&quot;</code></pre><p>After the deployment succeeded, you should consider deploying some masterdata entities into your metal-api. For example, you can add your first machine sizes, operating system images, partitions and networks. You can do this by further parametrizing the <a href="https://github.com/metal-stack/metal-roles/tree/master/control-plane/roles/metal">metal role</a>. Please check the role documentation on how to do that.</p><div class="admonition is-success"><header class="admonition-header">Tip</header><div class="admonition-body"><p>If you are having issues regarding the deployment take a look at the <a href="../troubleshoot/">troubleshoot document</a>. Please give feedback such that we can make the deployment of the metal-stack easier for you and for others!</p></div></div><p>The basic principles of how the metal control plane can be deployed should now be clear. It is now up to you to migrate the deployment execution into your CI.</p><div class="admonition is-info"><header class="admonition-header">Info</header><div class="admonition-body"><p>Image versions and ansible-role depedencies should be regularly checked for updates and adjusted according to the release notes.</p></div></div><h3 id="Setting-up-the-backup-restore-sidecar-1"><a class="docs-heading-anchor" href="#Setting-up-the-backup-restore-sidecar-1">Setting up the backup-restore-sidecar</a><a class="docs-heading-anchor-permalink" href="#Setting-up-the-backup-restore-sidecar-1" title="Permalink"></a></h3><p>The backup-restore-sidecar can come up very handy when you want to add another layer of security to the metal-stack databases in your Kubernetes cluster. The sidecar takes backups of the metal databases in small time intervals and stores them in a blobstore of a cloud provider. This way your metal-stack setup can even survive the deletion of your Kubernetes control plane cluster (including all volumes getting lost). After re-deploying metal-stack to another Kubernetes clusters, the databases should come up quite with the backup data in a matter of seconds.</p><p>Checkout the role documentation of the individual databases to find out how to configure the sidecar properly. You can also try out the mechanism from the <a href="https://github.com/metal-stack/backup-restore-sidecar">backup-restore-sidecar</a> repository.</p><h3 id="Authentication-1"><a class="docs-heading-anchor" href="#Authentication-1">Authentication</a><a class="docs-heading-anchor-permalink" href="#Authentication-1" title="Permalink"></a></h3><p>metal-stack uses <a href="https://github.com/dexidp/dex">dex</a> for providing user authentication through <a href="https://openid.net/connect/">OpenID Connect</a> (OIDC).</p><p>After setting up a dex server, you can parametrize the <a href="https://github.com/metal-stack/metal-roles/tree/master/control-plane/roles/metal">metal role</a> for using your dex server by defining the variable <code>metal_api_dex_address</code>.</p><div class="admonition is-info"><header class="admonition-header">Info</header><div class="admonition-body"><p>We also have dedicated controllers for using the dex server for Kubernetes clusters when deploying metal-stack along with the Gardener in your environment. The approach is described in further detail in the section <a href="#Gardener-with-metal-stack-1">Gardener with metal-stack</a>.</p></div></div><h2 id="Bootstrapping-a-Partition-1"><a class="docs-heading-anchor" href="#Bootstrapping-a-Partition-1">Bootstrapping a Partition</a><a class="docs-heading-anchor-permalink" href="#Bootstrapping-a-Partition-1" title="Permalink"></a></h2><h2 id="Partition-Deployment-1"><a class="docs-heading-anchor" href="#Partition-Deployment-1">Partition Deployment</a><a class="docs-heading-anchor-permalink" href="#Partition-Deployment-1" title="Permalink"></a></h2><h2 id="Gardener-with-metal-stack-1"><a class="docs-heading-anchor" href="#Gardener-with-metal-stack-1">Gardener with metal-stack</a><a class="docs-heading-anchor-permalink" href="#Gardener-with-metal-stack-1" title="Permalink"></a></h2></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../quickstart/">« Quickstart</a><a class="docs-footer-nextpage" href="../monitoring/">Monitoring »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Wednesday 3 June 2020 15:37">Wednesday 3 June 2020</span>. Using Julia version 1.4.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
