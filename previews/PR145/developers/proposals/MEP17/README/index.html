<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>BGP Data Plane Visibility · metal-stack</title><meta name="title" content="BGP Data Plane Visibility · metal-stack"/><meta property="og:title" content="BGP Data Plane Visibility · metal-stack"/><meta property="twitter:title" content="BGP Data Plane Visibility · metal-stack"/><meta name="description" content="Documentation for metal-stack."/><meta property="og:description" content="Documentation for metal-stack."/><meta property="twitter:description" content="Documentation for metal-stack."/><meta property="og:url" content="https://docs.metal-stack.io/developers/proposals/MEP17/README/"/><meta property="twitter:url" content="https://docs.metal-stack.io/developers/proposals/MEP17/README/"/><link rel="canonical" href="https://docs.metal-stack.io/developers/proposals/MEP17/README/"/><script data-outdated-warner src="../../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../search_index.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script><link href="../../../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../../../assets/youtube.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="metal-stack logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../../">metal-stack</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Home</a></li><li><a class="tocitem" href="../../../../getting-started/">Getting Started</a></li><li><span class="tocitem">Concepts</span><ul><li><a class="tocitem" href="../../../../concepts/why-metal-stack/">Why metal-stack</a></li><li><a class="tocitem" href="../../../../concepts/why-bare-metal/">Why Bare Metal</a></li><li><a class="tocitem" href="../../../../concepts/architecture/">Architecture</a></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Network</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../concepts/network/theory/">Theory</a></li><li><a class="tocitem" href="../../../../concepts/network/firewalls/">Firewalls</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Kubernetes</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../concepts/kubernetes/cloud-controller-manager/">Cloud Controller Manager</a></li><li><a class="tocitem" href="../../../../concepts/kubernetes/firewall-controller-manager/">Firewall Controller Manager</a></li><li><a class="tocitem" href="../../../../concepts/kubernetes/gardener/">Gardener</a></li><li><a class="tocitem" href="../../../../concepts/kubernetes/isolated-clusters/">Isolated Cluster</a></li><li><a class="tocitem" href="../../../../concepts/kubernetes/gpu-workers/">GPU Workers</a></li><li><a class="tocitem" href="../../../../concepts/kubernetes/storage/">Storage</a></li></ul></li></ul></li><li><span class="tocitem">For Operators</span><ul><li><a class="tocitem" href="../../../../operators/hardware/">Supported Hardware</a></li><li><a class="tocitem" href="../../../../operators/operating-systems/">Operating Systems</a></li><li><a class="tocitem" href="../../../../operators/deployment-guide/">Deployment Guide</a></li><li><a class="tocitem" href="../../../../operators/upgrades/">Upgrades</a></li><li><a class="tocitem" href="../../../../operators/troubleshoot/">Troubleshoot</a></li></ul></li><li><span class="tocitem">For Users</span><ul><li><a class="tocitem" href="../../../../users/client-libraries/">Client Libraries</a></li></ul></li><li><span class="tocitem">For Developers</span><ul><li><a class="tocitem" href="../../">Enhancement Proposals</a></li><li><a class="tocitem" href="../../../planning-meetings/">Planning Meetings</a></li><li><a class="tocitem" href="../../../contribution-guideline/">Contribution Guideline</a></li><li><a class="tocitem" href="../../../release-flow/">Release Flow</a></li><li><a class="tocitem" href="../../../community/">Community</a></li></ul></li><li><span class="tocitem">References</span><ul><li><a class="tocitem" href="../../../../references/apidocs/">API</a></li><li><input class="collapse-toggle" id="menuitem-7-2" type="checkbox"/><label class="tocitem" for="menuitem-7-2"><span class="docs-label">Components</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../references/external/mini-lab/README/">mini-lab</a></li><li><a class="tocitem" href="../../../../references/external/metalctl/README/">metalctl</a></li><li><a class="tocitem" href="../../../../references/external/csi-driver-lvm/README/">csi-driver-lvm</a></li><li><a class="tocitem" href="../../../../references/external/firewall-controller/README/">firewall-controller</a></li><li><a class="tocitem" href="../../../../references/external/tailscale/README/">tailscale</a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>BGP Data Plane Visibility</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>BGP Data Plane Visibility</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/metal-stack/docs.git" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="github.com/metal-stack/docs.git" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="BGP-Data-Plane-Visibility"><a class="docs-heading-anchor" href="#BGP-Data-Plane-Visibility">BGP Data Plane Visibility</a><a id="BGP-Data-Plane-Visibility-1"></a><a class="docs-heading-anchor-permalink" href="#BGP-Data-Plane-Visibility" title="Permalink"></a></h1><p>Currently, an operator cannot identify if an allocated IP is actually announced to the outer world. At the edge of the network we would like to gather information about all routes announced from within the network. This information should include a timestamp of the last announcement for each route. If the timestamp is older than some threshold we will assume that the addresses are not longer used.</p><p>To achieve this we will extend the scope of metal-core so it can run on all types of switches, not only on leaves. As a byproduct of this enhancement all switches will become visible via <code>metalctl switch ls</code>. On the switches the metal-core will collect BGP routes and report them to the metal-apiserver. The metal-apiserver will store these data to a separate table and query this table when an IP address is described.</p><h2 id="metal-core"><a class="docs-heading-anchor" href="#metal-core">metal-core</a><a id="metal-core-1"></a><a class="docs-heading-anchor-permalink" href="#metal-core" title="Permalink"></a></h2><h3 id="Switch-Types"><a class="docs-heading-anchor" href="#Switch-Types">Switch Types</a><a id="Switch-Types-1"></a><a class="docs-heading-anchor-permalink" href="#Switch-Types" title="Permalink"></a></h3><p>First of all, the metal-core should accept as an argument the type or role of the switch it is running on. Possible types are:</p><ul><li><code>leaf</code></li><li><code>spine</code></li><li><code>exit</code></li><li><code>mgmtleaf</code></li><li><code>mgmtspine</code></li></ul><p>Depending on the type its reconciliation loop will differ. The current behavior should mostly remain unchanged for leaf switches. Things to change for non-leaves:</p><p><strong>Phoned Home</strong></p><p>Currently, a <a href="https://github.com/metal-stack/go-lldpd">go-lldp</a> client is used to listen for LLDP messages from provisioned machines to report these as phoned-home events to the metal-api. This mechanism is only needed on leaf switches. On all other types of switch this entire procedure can be skipped.</p><p><strong>Port Configuration</strong></p><p>There are four kinds of ports for a leaf switch: spine uplink, unprovisioned port, firewall port, machine port. Depending on the kind of port its configuration will differ in regards to MTU, VLAN binding and VRF binding. Any non-leaf switches don&#39;t know anything about machines, firewalls and the provisioning cycle. Their port configuration is static.</p><p><strong>FRR Config</strong></p><p>The same goes for the FRR config. To dynamically adapt to machines being provisioned and unprovisioned, the metal-core periodically writes the <code>frr.conf</code> file. This dynamic configuration is only necessary on the leaf switches. All other switches need a static FRR config.</p><blockquote><p>In a future MEP we consider delegating the entire configuration of a switch to the metal-core. For now, all configuration that doesn&#39;t need to be dynamically adjusted will be deployed on the switch via metal-roles and the metal-core will mostly just report switch information to the metal-apiserver.</p></blockquote><h3 id="BGP-Announcements"><a class="docs-heading-anchor" href="#BGP-Announcements">BGP Announcements</a><a id="BGP-Announcements-1"></a><a class="docs-heading-anchor-permalink" href="#BGP-Announcements" title="Permalink"></a></h3><p>Route information can be retrieved in JSON format from vtysh. The metal-core should collect all routes it knows about and send them to the metal-apiserver along with a timestamp.</p><h3 id="Switch-to-Switch-Connections"><a class="docs-heading-anchor" href="#Switch-to-Switch-Connections">Switch-to-Switch Connections</a><a id="Switch-to-Switch-Connections-1"></a><a class="docs-heading-anchor-permalink" href="#Switch-to-Switch-Connections" title="Permalink"></a></h3><p>Similarly to the switch-to-machine connections where LLDP neighborship is used to learn about the physical connections, we can use LLDP to report connections between switches to the metal-apiserver. For this, a separate LLDP client should be used, that forwards all LLDP messages, not only those of provisioned machines.</p><h2 id="metal-apiserver"><a class="docs-heading-anchor" href="#metal-apiserver">metal-apiserver</a><a id="metal-apiserver-1"></a><a class="docs-heading-anchor-permalink" href="#metal-apiserver" title="Permalink"></a></h2><p>A new GRPC endpoint should be exposed by the metal-apiserver to report BGP routes.</p><pre><code class="language-proto hljs">service SwitchService {
  rpc ReportBGPRoutes(SwitchServiceReportBGPRoutesRequest) returns (SwitchServiceReportBGPRoutesResponse) {
    option (metalstack.api.v2.infra_roles) = INFRA_ROLE_EDITOR;
    option (metalstack.api.v2.infra_roles) = INFRA_ROLE_VIEWER;
    option (metalstack.api.v2.auditing) = AUDITING_EXCLUDED;
  }
}

message SwitchServiceReportBGPRoutesRequest {
  repeated BGPRoute bgpRoutes = 1;
}

message BGPRoute {
  string cidr = 1;
  string switch_id = 2;
  google.protobuf.Timestamp last_announced = 3;
}</code></pre><p>There should be a table for BGP routes in metaldb:</p><pre><code class="language-go hljs">type (
  BGPRoute struct {
    CIDR string `rethinkdb:&quot;cidr&quot;`
    LastAnnounced time.Time `rethinkdb:&quot;lastannounced&quot;`
  }

  BGPRoutes struct {
    Routes []BGPRoute `rethinkdb:&quot;routes&quot;`
  }
)</code></pre><p>Whenever new routes are reported they get merged into the existing ones by the strategy:</p><ul><li>when new, just add</li><li>when existing, update <code>last_announced</code> timestamp</li></ul><p>An expiration threshold should be defined and all expired routes should be cleaned up periodically.</p><p>When an IP address is described with <code>metalctl network ip describe</code> the BGP routes should be queried. If no route to the described IP was announced it should be indicated, e.g.</p><pre><code class="language-bash hljs">allocationuuid: allocation-id
description: my ip address
ipaddress: 100.0.0.1
name: ip-name
networkid: network-id
projectid: project-id
type: static
used: no # otherwise &#39;yes&#39;</code></pre></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Wednesday 18 June 2025 07:48">Wednesday 18 June 2025</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
