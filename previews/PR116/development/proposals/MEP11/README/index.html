<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Auditing of metal-stack resources · metal-stack</title><script data-outdated-warner src="../../../../assets/warner.js"></script><link rel="canonical" href="https://docs.metal-stack.io/development/proposals/MEP11/README/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script><link href="../../../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../../../assets/youtube.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="metal-stack logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../../">metal-stack</a></span></div><form class="docs-search" action="../../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Introduction</a></li><li><span class="tocitem">Overview</span><ul><li><a class="tocitem" href="../../../../overview/architecture/">Architecture</a></li><li><a class="tocitem" href="../../../../overview/networking/">Networking</a></li><li><a class="tocitem" href="../../../../overview/hardware/">Hardware Support</a></li><li><a class="tocitem" href="../../../../overview/os/">Operating Systems</a></li><li><a class="tocitem" href="../../../../overview/kubernetes/">Kubernetes Integration</a></li><li><a class="tocitem" href="../../../../overview/storage/">Storage</a></li><li><a class="tocitem" href="../../../../overview/comparison/">Comparison</a></li></ul></li><li><a class="tocitem" href="../../../../quickstart/">Quickstart</a></li><li><span class="tocitem">Installation &amp; Administration</span><ul><li><a class="tocitem" href="../../../../installation/deployment/">Installation</a></li><li><a class="tocitem" href="../../../../installation/monitoring/">Monitoring</a></li><li><a class="tocitem" href="../../../../installation/troubleshoot/">Troubleshoot</a></li></ul></li><li><span class="tocitem">User Guides</span><ul><li><a class="tocitem" href="../../../../external/mini-lab/README/">mini-lab</a></li><li><a class="tocitem" href="../../../../external/metalctl/README/">metalctl</a></li><li><a class="tocitem" href="../../../../external/csi-driver-lvm/README/">csi-driver-lvm</a></li><li><a class="tocitem" href="../../../../external/firewall-controller/README/">firewall-controller</a></li></ul></li><li><a class="tocitem" href="../../../../apidocs/apidocs/">API Documentation</a></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../../../client_libraries/">Client Libraries</a></li><li><a class="tocitem" href="../../../roadmap/">Roadmap</a></li><li><a class="tocitem" href="../../">Enhancement Proposals</a></li><li><a class="tocitem" href="../../../contributing/">Contributing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Auditing of metal-stack resources</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Auditing of metal-stack resources</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/metal-stack/docs/blob/master/docs/src/development/proposals/MEP11/README.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Auditing-of-metal-stack-resources"><a class="docs-heading-anchor" href="#Auditing-of-metal-stack-resources">Auditing of metal-stack resources</a><a id="Auditing-of-metal-stack-resources-1"></a><a class="docs-heading-anchor-permalink" href="#Auditing-of-metal-stack-resources" title="Permalink"></a></h1><p>Currently no logs of the ownership of resources like machines, networks, ips and volumes are generated or kept.Though due to legal requirements data centers are required to keep track of this ownership over time to prevent liability issues when opening the platform for external users.</p><p>In this proposal we want to introduce a flexible and low-maintenance approach for auditing on top of <a href="https://www.meilisearch.com/">Meilisearch</a>.</p><h2 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h2><p>In general our auditing logs will be collected by a request interceptor or middleware. Every request and response will be processed and eventually logged to Meilisearch. Meilisearch will be configured to regularly create chunks of the auditing logs. These finished chunks will be backed up to a S3 compatible storage with a read-only option enabled.</p><p>Of course sensitve data like session keys or passwords will be redacted before logging. We want to track relevant requests and responses. If auditing the request fails, the request itself will be aborted and will not be processed further. The requests and responses that will be audited will be annotated with a correlation id.</p><p>Transferring the meilisearch auditing data chunks to the S3 compatible storage will be done by a cronjob that is executed periodically. To avoid data manipulation the S3 compatible storage will be configured to be read-only.</p><h2 id="Whitelisting"><a class="docs-heading-anchor" href="#Whitelisting">Whitelisting</a><a id="Whitelisting-1"></a><a class="docs-heading-anchor-permalink" href="#Whitelisting" title="Permalink"></a></h2><p>To reduce the amount of unnecessary logs we want to introduce a whitelist of resources and operations on those that should be logged. Other requests will be passed directly to the next middleware or web service without any further processing.</p><p>As we are only interested in mutating endpoints, we ignore all GET requests. The whitelist includes the following endpoints:</p><ul><li>Machines <code>v1/machine</code><ul><li><code>POST v1/machine/</code> update machine</li><li><code>POST v1/machine/register</code> register machine, <em>if still present</em></li><li><code>POST v1/machine/allocate</code> allocate machine</li><li><code>POST v1/machine/{id}/finalize-allocation</code> finalize allocation, <em>if still present</em></li><li><code>POST v1/machine/{id}/state</code> set machine state</li><li><code>POST v1/machine/{id}/chassis-identify-led-state</code> set the state of a chassis identify LED, <em>if still present</em></li><li><code>DELETE v1/machine/{id}/free</code> free machine</li><li><code>DELETE v1/machine/{id}</code> delete machine</li><li><code>POST v1/machine/{id}/reinstall</code> reinstall machine</li><li><code>POST v1/machine/{id}/abort-reinstall</code> aborts reinstall, <em>if still present</em></li><li><code>POST v1/machine/{id}/event</code> adds a provisioning event, <em>if still present</em></li><li><code>POST v1/machine/update-firmware/{id}</code> update firmware of machine</li></ul></li><li>Networks <code>v1/network</code><ul><li><code>DELETE v1/network/{id}</code> delete network</li><li><code>PUT v1/network/</code> create network</li><li><code>POST v1/network/</code> update network</li><li><code>POST v1/network/allocate</code> allocate network</li><li><code>DELETE v1/network/free/{id}</code> free network</li><li><code>POST v1/network/free/{id}</code> <em>deprecated</em> free network</li></ul></li><li>IPs <code>v1/ip</code><ul><li><code>DELETE v1/ip/free/{id}</code> free ip</li><li><code>POST v1/ip/free/{id}</code> <em>deprecated</em> free ip</li><li><code>POST v1/ip/</code> update ip</li><li><code>POST v1/ip/allocate</code> allocate ip</li><li><code>POST v1/ip/allocate/{id}</code> allocate specific ip</li></ul></li><li>GRPC Services and methods, that can create machines<ul><li><code>api.v1.BootService</code> method <code>Register</code></li><li><code>api.v1.EventService</code> method <code>Send</code></li></ul></li></ul><p>The following resources and operations will explicitly not be logged even though they are mutating the state of the system:</p><ul><li>Machines <code>v1/machine</code><ul><li><code>POST v1/machine/{id}/power/on</code> power on machine</li><li><code>POST v1/machine/{id}/power/off</code> power off machine</li><li><code>POST v1/machine/{id}/power/reset</code> reset machine</li><li><code>POST v1/machine/{id}/power/cycle</code> send power cycle to machine</li><li><code>POST v1/machine/{id}/power/bios</code> boot machine into bios</li><li><code>POST v1/machine/{id}/power/disk</code> boot machine from disk</li><li><code>POST v1/machine/{id}/power/pxe</code> boot machine from pxe</li><li><code>POST v1/machine/{id}/power/chassis-identify-led-on</code> turn on chassis identify LED</li><li><code>POST v1/machine/{id}/power/chassis-identify-led-off</code> turn off chassis identify LED</li></ul></li></ul><h2 id="Affected-components"><a class="docs-heading-anchor" href="#Affected-components">Affected components</a><a id="Affected-components-1"></a><a class="docs-heading-anchor-permalink" href="#Affected-components" title="Permalink"></a></h2><ul><li>metal-api grpc server needs an auditing interceptor</li><li>metal-api web server needs an auditing filter / middleware</li><li>metal-api needs new command line arguments to configure the auditing</li><li>mini-lab needs a Meilisearch instance</li><li>mini-lab may need a local S3 compatible storage</li><li>Consider auditing of volume allocations and freeings outside of metal-stack</li></ul><h2 id="Alternatives-considered"><a class="docs-heading-anchor" href="#Alternatives-considered">Alternatives considered</a><a id="Alternatives-considered-1"></a><a class="docs-heading-anchor-permalink" href="#Alternatives-considered" title="Permalink"></a></h2><p>Instead of using Meilisearch we investigated using an immutable database like <a href="https://immudb.io/">immudb</a>. But immudb does not support chunking of data and due to its immutable nature, we will never be able to free up space of expired data. Even if we are legally allowed or required to delete data, we will not be able to do so with immudb.</p></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.10 on <span class="colophon-date" title="Tuesday 6 September 2022 11:19">Tuesday 6 September 2022</span>. Using Julia version 1.6.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
