<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Auditing of metal-stack resources · metal-stack</title><meta name="title" content="Auditing of metal-stack resources · metal-stack"/><meta property="og:title" content="Auditing of metal-stack resources · metal-stack"/><meta property="twitter:title" content="Auditing of metal-stack resources · metal-stack"/><meta name="description" content="Documentation for metal-stack."/><meta property="og:description" content="Documentation for metal-stack."/><meta property="twitter:description" content="Documentation for metal-stack."/><meta property="og:url" content="https://docs.metal-stack.io/development/proposals/MEP11/README/"/><meta property="twitter:url" content="https://docs.metal-stack.io/development/proposals/MEP11/README/"/><link rel="canonical" href="https://docs.metal-stack.io/development/proposals/MEP11/README/"/><script data-outdated-warner src="../../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../search_index.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script><link href="../../../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../../../assets/youtube.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="metal-stack logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../../">metal-stack</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Introduction</a></li><li><span class="tocitem">Overview</span><ul><li><a class="tocitem" href="../../../../overview/architecture/">Architecture</a></li><li><a class="tocitem" href="../../../../overview/networking/">Networking</a></li><li><a class="tocitem" href="../../../../overview/hardware/">Hardware Support</a></li><li><a class="tocitem" href="../../../../overview/os/">Operating Systems</a></li><li><a class="tocitem" href="../../../../overview/kubernetes/">Kubernetes Integration</a></li><li><a class="tocitem" href="../../../../overview/isolated-kubernetes/">Isolated Kubernetes</a></li><li><a class="tocitem" href="../../../../overview/gpu-support/">GPU Support</a></li><li><a class="tocitem" href="../../../../overview/storage/">Storage</a></li><li><a class="tocitem" href="../../../../overview/comparison/">Comparison</a></li></ul></li><li><a class="tocitem" href="../../../../quickstart/">Quickstart</a></li><li><span class="tocitem">Installation &amp; Administration</span><ul><li><a class="tocitem" href="../../../../installation/deployment/">Installation</a></li><li><a class="tocitem" href="../../../../installation/updates/">Releases and Updates</a></li><li><a class="tocitem" href="../../../../installation/monitoring/">Monitoring</a></li><li><a class="tocitem" href="../../../../installation/troubleshoot/">Troubleshoot</a></li></ul></li><li><span class="tocitem">User Guides</span><ul><li><a class="tocitem" href="../../../../external/mini-lab/README/">mini-lab</a></li><li><a class="tocitem" href="../../../../external/metalctl/README/">metalctl</a></li><li><a class="tocitem" href="../../../../external/csi-driver-lvm/README/">csi-driver-lvm</a></li><li><a class="tocitem" href="../../../../external/firewall-controller/README/">firewall-controller</a></li></ul></li><li><a class="tocitem" href="../../../../apidocs/apidocs/">API Documentation</a></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../../../client_libraries/">Client Libraries</a></li><li><a class="tocitem" href="../../../roadmap/">Roadmap</a></li><li><a class="tocitem" href="../../">Enhancement Proposals</a></li><li><a class="tocitem" href="../../../contributing/">Contributing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Auditing of metal-stack resources</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Auditing of metal-stack resources</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/metal-stack/docs.git" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="github.com/metal-stack/docs.git" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Auditing-of-metal-stack-resources"><a class="docs-heading-anchor" href="#Auditing-of-metal-stack-resources">Auditing of metal-stack resources</a><a id="Auditing-of-metal-stack-resources-1"></a><a class="docs-heading-anchor-permalink" href="#Auditing-of-metal-stack-resources" title="Permalink"></a></h1><p>Currently no logs of the ownership of resources like machines, networks, ips and volumes are generated or kept. Though due to legal requirements data centers are required to keep track of this ownership over time to prevent liability issues when opening the platform for external users.</p><p>In this proposal we want to introduce a flexible and low-maintenance approach for auditing on top of <a href="https://www.meilisearch.com/">Meilisearch</a>.</p><h2 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h2><p>In general our auditing logs will be collected by a request interceptor or middleware. Every request and response will be processed and eventually logged to Meilisearch. Meilisearch will be configured to regularly create chunks of the auditing logs. These finished chunks will be backed up to a S3 compatible storage with a read-only option enabled.</p><p>Of course sensitive data like session keys or passwords will be redacted before logging. We want to track relevant requests and responses. If auditing the request fails, the request itself will be aborted and will not be processed further. The requests and responses that will be audited will be annotated with a correlation id.</p><p>Transferring the meilisearch auditing data chunks to the S3 compatible storage will be done by a sidecar cronjob that is executed periodically. To avoid data manipulation the S3 compatible storage will be configured to be read-only.</p><h2 id="Whitelisting"><a class="docs-heading-anchor" href="#Whitelisting">Whitelisting</a><a id="Whitelisting-1"></a><a class="docs-heading-anchor-permalink" href="#Whitelisting" title="Permalink"></a></h2><p>To reduce the amount of unnecessary logs we want to introduce a whitelist of resources and operations on those that should be logged. Other requests will be passed directly to the next middleware or web service without any further processing.</p><p>As we are only interested in mutating endpoints, we ignore all <code>GET</code> requests. The whitelist includes all <code>POST</code>, <code>PUT</code>, <code>PATCH</code> and <code>DELETE</code> endpoints of the HTTP middleware except for the following (non-manipulating) route suffixes:</p><ul><li><code>/find</code></li><li><code>/notify</code></li><li><code>/try</code> and <code>/match</code></li><li><code>/capacity</code></li><li><code>/from-hardware</code></li></ul><p>Regarding GRPC audit trails, they are not so interesting because only internal clients are using this API. However, we can log the trails of the <code>Boot</code> service, which can be interesting to revise the machine lifecycle.</p><h2 id="Chunking-in-Meilisearch"><a class="docs-heading-anchor" href="#Chunking-in-Meilisearch">Chunking in Meilisearch</a><a id="Chunking-in-Meilisearch-1"></a><a class="docs-heading-anchor-permalink" href="#Chunking-in-Meilisearch" title="Permalink"></a></h2><p>We want our data to be chunked in Meilisearch. To accomplish this, we rotate the index identifier on a scheduled basis. The index identifiers will be derived from the current date and time.</p><p>To keep things simple, we only support hourly, daily and monthly rotation. The eventually prefixed index names will only include relevant parts of date and time like <code>2021-01</code>, <code>2021-01-01</code> or <code>2021-01-01_13</code>.</p><p>The metal-api will only write to the current index and switches to the new index on rotation. The metal-api will never read or update data in any indices.</p><h2 id="Moving-chunks-to-S3-compatible-storage"><a class="docs-heading-anchor" href="#Moving-chunks-to-S3-compatible-storage">Moving chunks to S3 compatible storage</a><a id="Moving-chunks-to-S3-compatible-storage-1"></a><a class="docs-heading-anchor-permalink" href="#Moving-chunks-to-S3-compatible-storage" title="Permalink"></a></h2><p>As Meilisearch will be filled with data over time, we want to move completed chunks to a S3 compatible storage. This will be done by a sidecar cronjob that is executed periodically. Note that the periods of the index rotation and the cronjob execution don&#39;t have to match.</p><p>When the backup process gets started, it initiates a <a href="https://www.meilisearch.com/docs/learn/advanced/dumps">Meilisearch dump</a> of the whole database across all indices. Once the returned task is finished, the dump must be copied from a Meilisearch volume to the S3 compatible storage. After a successful copy, the dump can be deleted.</p><p>Now we want to remove all indices from Meilisearch, except the most recent one. For this, we <a href="https://www.meilisearch.com/docs/reference/api/indexes#list-all-indexes">get all indices</a>, sort them and <a href="https://www.meilisearch.com/docs/reference/api/indexes#delete-an-index">delete each index</a> except the most recent one to avoid data loss.</p><p>For the actual implementation, we can build upon <a href="https://github.com/metal-stack/backup-restore-sidecar">backup-restore-sidecar</a>. But due to the index rotation and the fact, that older indices need to be deleted, this probably does not fit into the mentioned sidecar.</p><h2 id="S3-compatible-storage"><a class="docs-heading-anchor" href="#S3-compatible-storage">S3 compatible storage</a><a id="S3-compatible-storage-1"></a><a class="docs-heading-anchor-permalink" href="#S3-compatible-storage" title="Permalink"></a></h2><p>The dumps of chunks should automatically deleted after a certain amount of time, once we are either no longer allowed or required to keep them. The default retention time will be 6 months. Ideally already uploaded chunks should be read-only to prevent data manipulation.</p><p>A candidate for the S3 compatible storage is Google Cloud Storage, which allows to configure automatic expiration of objects through a <a href="https://cloud.google.com/storage/docs/managing-lifecycles?hl=en#storage-set-lifecycle-config-go">lifecycle rule</a>.</p><h2 id="Affected-components"><a class="docs-heading-anchor" href="#Affected-components">Affected components</a><a id="Affected-components-1"></a><a class="docs-heading-anchor-permalink" href="#Affected-components" title="Permalink"></a></h2><ul><li>metal-api grpc server needs an auditing interceptor</li><li>metal-api web server needs an auditing filter chain / middleware</li><li>metal-api needs new command line arguments to configure the auditing</li><li>mini-lab needs a Meilisearch instance</li><li>mini-lab may need a local S3 compatible storage</li><li>we need a sidecar to implement the backup to S3 compatible storage</li><li>Consider auditing of volume allocations and freeings outside of metal-stack</li></ul><h2 id="Alternatives-considered"><a class="docs-heading-anchor" href="#Alternatives-considered">Alternatives considered</a><a id="Alternatives-considered-1"></a><a class="docs-heading-anchor-permalink" href="#Alternatives-considered" title="Permalink"></a></h2><p>Instead of using Meilisearch we investigated using an immutable database like <a href="https://immudb.io/">immudb</a>. But immudb does not support chunking of data and due to its immutable nature, we will never be able to free up space of expired data. Even if we are legally allowed or required to delete data, we will not be able to do so with immudb.</p><p>In another variant of the Meilisearch approach the metal-api would also be responsible for copying chunks to the S3 compatible storage and deleting old indices. But separating the concerns allows completely different implementations for every deployment stage.</p></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Tuesday 25 March 2025 13:22">Tuesday 25 March 2025</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
