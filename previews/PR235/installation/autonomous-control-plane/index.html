<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Autonomous Control Plane, aka solve the bootstrap problem · metal-stack</title><meta name="title" content="Autonomous Control Plane, aka solve the bootstrap problem · metal-stack"/><meta property="og:title" content="Autonomous Control Plane, aka solve the bootstrap problem · metal-stack"/><meta property="twitter:title" content="Autonomous Control Plane, aka solve the bootstrap problem · metal-stack"/><meta name="description" content="Documentation for metal-stack."/><meta property="og:description" content="Documentation for metal-stack."/><meta property="twitter:description" content="Documentation for metal-stack."/><meta property="og:url" content="https://docs.metal-stack.io/installation/autonomous-control-plane/"/><meta property="twitter:url" content="https://docs.metal-stack.io/installation/autonomous-control-plane/"/><link rel="canonical" href="https://docs.metal-stack.io/installation/autonomous-control-plane/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../assets/youtube.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="metal-stack logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">metal-stack</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><span class="tocitem">Overview</span><ul><li><a class="tocitem" href="../../overview/architecture/">Architecture</a></li><li><a class="tocitem" href="../../overview/networking/">Networking</a></li><li><a class="tocitem" href="../../overview/hardware/">Hardware Support</a></li><li><a class="tocitem" href="../../overview/os/">Operating Systems</a></li><li><a class="tocitem" href="../../overview/kubernetes/">Kubernetes Integration</a></li><li><a class="tocitem" href="../../overview/isolated-kubernetes/">Isolated Kubernetes</a></li><li><a class="tocitem" href="../../overview/gpu-support/">GPU Support</a></li><li><a class="tocitem" href="../../overview/storage/">Storage</a></li><li><a class="tocitem" href="../../overview/comparison/">Comparison</a></li></ul></li><li><a class="tocitem" href="../../quickstart/">Quickstart</a></li><li><span class="tocitem">Installation &amp; Administration</span><ul><li><a class="tocitem" href="../deployment/">Installation</a></li><li><a class="tocitem" href="../updates/">Releases and Updates</a></li><li><a class="tocitem" href="../monitoring/">Monitoring</a></li><li><a class="tocitem" href="../troubleshoot/">Troubleshoot</a></li></ul></li><li><span class="tocitem">User Guides</span><ul><li><a class="tocitem" href="../../external/mini-lab/README/">mini-lab</a></li><li><a class="tocitem" href="../../external/metalctl/README/">metalctl</a></li><li><a class="tocitem" href="../../external/csi-driver-lvm/README/">csi-driver-lvm</a></li><li><a class="tocitem" href="../../external/firewall-controller/README/">firewall-controller</a></li></ul></li><li><a class="tocitem" href="../../apidocs/apidocs/">API Documentation</a></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../../development/client_libraries/">Client Libraries</a></li><li><a class="tocitem" href="../../development/roadmap/">Roadmap</a></li><li><a class="tocitem" href="../../development/proposals/">Enhancement Proposals</a></li><li><a class="tocitem" href="../../development/contributing/">Contributing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Autonomous Control Plane, aka solve the bootstrap problem</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Autonomous Control Plane, aka solve the bootstrap problem</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/metal-stack/docs.git" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="github.com/metal-stack/docs.git" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Autonomous-Control-Plane,-aka-solve-the-bootstrap-problem"><a class="docs-heading-anchor" href="#Autonomous-Control-Plane,-aka-solve-the-bootstrap-problem">Autonomous Control Plane, aka solve the bootstrap problem</a><a id="Autonomous-Control-Plane,-aka-solve-the-bootstrap-problem-1"></a><a class="docs-heading-anchor-permalink" href="#Autonomous-Control-Plane,-aka-solve-the-bootstrap-problem" title="Permalink"></a></h1><p>Setting up a metal-stack.io environment in your own datacenter requires a control plane to be present which hosts the metal-stack api. If you plan to spin up kubernetes clusters, either with gardener.cloud or cluster api, the requirement for this control plane raises. The control plane must be running in a kubernetes cluster, which offers at least the following features:</p><ul><li>Loadbalancing</li><li>Persistent Storage</li><li>Access to a object storage for automatic backups of the stateful sets</li><li>Access to a DNS provider which is supported by one of the dns extensions in use.</li></ul><p>This cluster must also be highly available to prevent complete loss of control over the managed resources in the datacenter. Regular kubernetes updates to apply security fixes and feature updates must be possible in a automated manner.</p><p>The most obvious and simple solution is to use one of the managed kubernetes offerings from another cloud provider.</p><p>But there are use cases, where it is not possible because of network restrictions, or because the company compliances does forbidd the usage of external datacenter products. For such cases a solution must be found which produces the control plane inside the own datacenter but with reasonable day two operational effort.</p><ul><li><a href="#Autonomous-Control-Plane,-aka-solve-the-bootstrap-problem">Autonomous Control Plane, aka solve the bootstrap problem</a></li><li class="no-marker"><ul><li><a href="#Possible-Solutions">Possible Solutions</a></li><li><a href="#Use-your-own-dogfood">Use your own dogfood</a></li><li class="no-marker"><ul><li><a href="#Architekture">Architekture</a></li><li class="no-marker"><ul><li><a href="#Needle">Needle</a></li></ul></li></ul></li><li><a href="#Open-Topics">Open Topics</a></li></ul></li></ul><h2 id="Possible-Solutions"><a class="docs-heading-anchor" href="#Possible-Solutions">Possible Solutions</a><a id="Possible-Solutions-1"></a><a class="docs-heading-anchor-permalink" href="#Possible-Solutions" title="Permalink"></a></h2><p>No complete list.</p><ul><li>vmware and rancher</li><li>talos</li><li>3 physical machines with kubespray</li></ul><p>...</p><p>All of these solutions add another stack which is probably new to the team which already operates the metal-stack environment.</p><p>TODO: can we provide a list which of the requirements can be solved with all of the alternatives.</p><h2 id="Use-your-own-dogfood"><a class="docs-heading-anchor" href="#Use-your-own-dogfood">Use your own dogfood</a><a id="Use-your-own-dogfood-1"></a><a class="docs-heading-anchor-permalink" href="#Use-your-own-dogfood" title="Permalink"></a></h2><p>With metal-stack.io we already have the possibility to create an manage kubernetes cluster with the help of gardener.cloud. Use this stack to create a the control plane clusters only. Do not try to create more clusters for other purposes than metal-stack control planes. If this restriction applies, the requirement for a control plane for this metal-stack setup can be minimal.</p><p>This metal-stack setup also requires a control plane to host metal-api and gardener, but this control plane does not have huge resource requirements in terms of cpu, memore and storage. For this initial control plane cluster we could use <a href="https://kind.sigs.k8s.io/">kind</a> running on a single server which manages the initial metal-stack partitin to host the control plane for the real setup.</p><p>This is a chain of two metal-stack environments.</p><h3 id="Architekture"><a class="docs-heading-anchor" href="#Architekture">Architekture</a><a id="Architekture-1"></a><a class="docs-heading-anchor-permalink" href="#Architekture" title="Permalink"></a></h3><p>A high-level architecture consists of two metal-stack.io environments, one for the control plane, the second one for the production or real environment. It might also be possible to call the initial metal-stack.io environment the metal-stack seed, and the actual production environment the metal-stack seed.</p><p>We could even use some names for this environments which match better to metal, like <code>needle</code> and nail. So, a <code>needle</code> metal-stack is used to create a <code>nail</code> metal-stack environment.</p><p><img src="../autonomous-control-plane-images/metal-stack-chain.drawio.svg" alt="metal-stack-chain"/></p><p>The <code>needle</code> and the <code>nail</code> metal-stack have both a control plane and a set of physical bare metal machines they manage and operate on.</p><h4 id="Needle"><a class="docs-heading-anchor" href="#Needle">Needle</a><a id="Needle-1"></a><a class="docs-heading-anchor-permalink" href="#Needle" title="Permalink"></a></h4><p>In case of the <code>needle</code> the control plane is small and running inside a kind cluster, the physical bare metal machines, can be any machines and switches which are supported by metal stack, but can be smaller in terms of cpu, memory and network speed, because these machines must only be capable of running the <code>nail</code> metal stack control plane.</p><ol><li>Control Plane</li></ol><p>In the most simple case the <code>needle</code> control plane is based on kind which is running on a machine which was setup manually/partly automated with a debian:12 operating system. This machine provides a decent amount of cpu, memory and storage locally to store all persistent data locally. The amount of cpus and memory depends on the required size of the expected <code>nail</code> control plane. A typical single socket server with 8-16 cores and 64GB of RAM and two NVMe drives of 1TB would be a good starting point.</p><p>In a typical kind setup, stateful set would not survive their data once the kind cluster was terminated and started again. But there is a possibility to define parts of the local storage of the server to be provided to the kind cluster for the PVCs. With that, kind could be terminated and started again, for example to update and reboot the host os, or update kind itself, the data will still be there.</p><p>Example kind configuration for persistent storage on the hosts os:</p><pre><code class="language-yaml hljs">kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: needle-control-plane
nodes:
- role: control-plane
  # add a mount from /path/to/my/files on the host to /files on the node
  extraMounts:
  - hostPath: /path/to/my/files
    containerPath: /files
</code></pre><p>As mentioned before, kind is used to host the <code>needle</code> control plane. For a gardener managed kubernetes setup, metal-stack and gardener will be deployed into this cluster. This deployment can be done by a gitlab runner which is running on this machine. The mini-lab will be used as a base for this deployment. The current development of gardener-in-minilab must be extended to host all required extensions to make this a working metal stack control plane which can manage the machines in the attached bare metal setup.</p><p>A second kind cluster is started on this machine to host services which are required to complete the service. A non-complete list would be:</p><ul><li>PowerDNS to server as a DNS Server for all dns entries which needs to be created in the needle, like api.needle.metal-stack.local, gardener-api.needle.metal-stack.local and the dns entries for the api servers of the create kubernetes clusters.</li><li>NTP</li><li>Monitoring for the <code>needle</code> partition ?</li><li>Optional: Container Registry to host all metal-stack and gardener containers</li><li>Optional: Letsencrypt <a href="https://github.com/letsencrypt/boulder">boulder</a> as a certificate authority</li><li>...</li></ul><p><img src="../autonomous-control-plane-images/needle-control-plane.drawio.svg" alt="needle-control-plane"/></p><p>1.1. Control Plane High Availability</p><p>Running the <code>needle</code> control plane on a single physical server is not as available as it should be in such a use case. It should be possible to survive a loss of this server, because the server could be lost by many events, such as hardware failure, disk corruption or even failure of the datacenter location where this server is deployed.</p><p>Setting up a second server with the same software components is an option, but the problem of data redundancy must be solved, because neither the gardener control plane, nor the metal-stack control plane can be instantiated twice.</p><p>Given that we provide part of the local storage of the server as backing storage for the stateful sets in the kind cluster, the data stored on the server itself must be synced to a second server in some way.</p><p>Her comes <a href="https://github.com/LINBIT/drbd">DRBD</a> into play, this is a linux kernel module which can be configured to mirror one or more local block devices to another server connected over tcp. With the help of <a href="https://www.clusterlabs.org/pacemaker/">pacemaker</a> a coordinated failover of resources running on top of filesystems created on such replicated drbd devices, a high available statefule server pair is possible. It is also possible to prevent split brain if both servers have a out-of-band management build in with power off capability. DRBD can also be configured to sync storage between WAN links with a higher latency by using a async mechanism.</p><p>Sample drbd configuration:</p><pre><code class="language-conf hljs">resource needle-control-plane {
  meta-disk internal;
  device /dev/drbd0;
  syncer {
    verify-alg sha1;
  }
  net {
    allow-two-primaries;
  }
  on needle1 {
    disk /dev/nvme0n1;
    address 192.168.1.101:7789;
  }
  on needle2 {
    disk /dev/nvme0n1;
    address 192.168.1.102:7789;
  }
}</code></pre><p>TODO: LVM Volumes</p><p>Logical View</p><p><img src="../autonomous-control-plane-images/needle-control-plane-ha.drawio.svg" alt="needle-control-plane-ha"/></p><p>Physical View, minimal ha setup which is only suitable for 1 Seed and 1 Shoot</p><p><img src="../autonomous-control-plane-images/needle-rack.drawio.svg" alt="needle-rack"/></p><p>Physical View, bigger ha setup which is spread to two datacenters, capable to create 1 Seed with 3 nodes and 2 Shoots with 3 nodes each and still 2 waiting machines.</p><p><img src="../autonomous-control-plane-images/needle-rack-big.drawio.svg" alt="needle-rack-big"/></p><ol><li>Partition</li></ol><p>The partition which is managed by the metal-stack <code>needle</code> can be a simple and small hardware setup but yet capable enough to host the metal-stack <code>nail</code> control plane. It can follow the metal-stack minimal setup which provides about 8-16 small servers connected to a 1G/s or 10G/s network dataplane. Central storage is optional as the persistence of the services running in these clusters is always backed up to a central object storage. Operations would be much easier if a central storage is provided.</p><p>A seed must be created which is responsible for hosting the control planes of the shoots in this partition. The amount of shoots should be minimal, most of the time, two shoots, one for hosting gardener and one for metal-stack.</p><p><img src="../autonomous-control-plane-images/needle-partition.drawio.svg" alt="needle-partition"/></p><ol><li>Network Diagram</li></ol><p>TODO: Where to connect the <code>needle</code> servers</p><h2 id="Open-Topics"><a class="docs-heading-anchor" href="#Open-Topics">Open Topics</a><a id="Open-Topics-1"></a><a class="docs-heading-anchor-permalink" href="#Open-Topics" title="Permalink"></a></h2><ul><li>Naming of the metal-stack chain elements, is <code>needle</code> and <code>nail</code> appropriate ?</li><li>Storage in the <code>needle</code> partition<ul><li><a href="https://min.io/docs/directpv">MinIO DirectPV</a> –&gt; new to me, dont know exactly how this works, looks interesting</li><li>lightOS</li><li><a href="https://github.com/poettering/diskomator">Diskomator</a> –&gt; Crazy</li><li>the needle server as initiator, maybe also replicated with drbd ?<ul><li><a href="https://ssdcentral.net/getting-started-with-nvme-over-fabrics-with-tcp/">NVMEoTCP Howto</a></li><li><a href="https://jing.rocks/2023/06/13/Experimenting-with-NVMe-over-TCP.html">NVMEoTCP Howto</a></li></ul></li><li>Storage Appliance like Synology</li></ul></li><li>S3 Object storage is considered as provided</li><li>AirGapped is out of scope for now</li><li>IP address ranges and families</li><li>Consider <a href="https://github.com/gardener/gardener/blob/master/docs/proposals/28-autonomous-shoot-clusters.md">Autonomous Shoots</a> for the <code>needle</code> <code>seed</code></li><li>Take a look at: <a href="https://github.com/robgil/microdatacenter">Description of a Microdatacenter</a></li></ul></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Wednesday 4 December 2024 14:32">Wednesday 4 December 2024</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
