<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Multi-tenancy for the metal-api · metal-stack</title><script data-outdated-warner src="../../../../assets/warner.js"></script><link rel="canonical" href="https://docs.metal-stack.io/development/proposals/MEP4/README/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script><link href="../../../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../../../assets/youtube.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="metal-stack logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../../">metal-stack</a></span></div><form class="docs-search" action="../../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Introduction</a></li><li><span class="tocitem">Overview</span><ul><li><a class="tocitem" href="../../../../overview/architecture/">Architecture</a></li><li><a class="tocitem" href="../../../../overview/networking/">Networking</a></li><li><a class="tocitem" href="../../../../overview/hardware/">Hardware Support</a></li><li><a class="tocitem" href="../../../../overview/os/">Operating Systems</a></li><li><a class="tocitem" href="../../../../overview/kubernetes/">Kubernetes Integration</a></li><li><a class="tocitem" href="../../../../overview/storage/">Storage</a></li><li><a class="tocitem" href="../../../../overview/comparison/">Comparison</a></li></ul></li><li><a class="tocitem" href="../../../../quickstart/">Quickstart</a></li><li><span class="tocitem">Installation &amp; Administration</span><ul><li><a class="tocitem" href="../../../../installation/deployment/">Installation</a></li><li><a class="tocitem" href="../../../../installation/monitoring/">Monitoring</a></li><li><a class="tocitem" href="../../../../installation/troubleshoot/">Troubleshoot</a></li></ul></li><li><span class="tocitem">User Guides</span><ul><li><a class="tocitem" href="../../../../external/mini-lab/README/">mini-lab</a></li><li><a class="tocitem" href="../../../../external/metalctl/README/">metalctl</a></li><li><a class="tocitem" href="../../../../external/csi-driver-lvm/README/">csi-driver-lvm</a></li><li><a class="tocitem" href="../../../../external/firewall-controller/README/">firewall-controller</a></li></ul></li><li><a class="tocitem" href="../../../../apidocs/apidocs/">API Documentation</a></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../../../client_libraries/">Client Libraries</a></li><li><a class="tocitem" href="../../../roadmap/">Roadmap</a></li><li><a class="tocitem" href="../../">Enhancement Proposals</a></li><li><a class="tocitem" href="../../../contributing/">Contributing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Multi-tenancy for the metal-api</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Multi-tenancy for the metal-api</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/metal-stack/docs/blob/master/docs/src/development/proposals/MEP4/README.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Multi-tenancy-for-the-metal-api"><a class="docs-heading-anchor" href="#Multi-tenancy-for-the-metal-api">Multi-tenancy for the metal-api</a><a id="Multi-tenancy-for-the-metal-api-1"></a><a class="docs-heading-anchor-permalink" href="#Multi-tenancy-for-the-metal-api" title="Permalink"></a></h1><p>In the past we decided to treat the metal-api as a &quot;low-level API&quot;, i.e. the API does not know anything about projects and tenants. A user with editor access can for example assign machines to every project he desires, he can see all the machines available and control them. Even though we always wanted to keep open the possibility to just offer bare metal machines to the end-user, the ultimate objective has always been to create an API for Kubernetes clusters. Hence, we tried to keep the metal-api code base as small as possible and we added resource scoping to a &quot;higher-level API&quot;, the cloud-api, a component that is not open-source. From there, a user would be able to only see his own clusters and IP addresses.</p><p>The implication is that the metal-api has no multi-tenancy without another layer on top of it that implements resource scoping. One can say that we treat clusters as first-class citizens. In regard of clusters we fulfill the objective that we had from the very beginning: provide a multi-tenant API for Kubernetes clusters to the end-users.</p><p>However, as time passed by, things changed: The metal-stack is becoming an open-source product and we already have promising adopters of our product, who are willing to contribute to metal-stack. This is a serious chance of making our product better and more successful. It turns out that the decision we made was sufficient for us, but for others it is not.</p><h2 id="Why-adopters-need-multi-tenancy-in-the-metal-api"><a class="docs-heading-anchor" href="#Why-adopters-need-multi-tenancy-in-the-metal-api">Why adopters need multi-tenancy in the metal-api</a><a id="Why-adopters-need-multi-tenancy-in-the-metal-api-1"></a><a class="docs-heading-anchor-permalink" href="#Why-adopters-need-multi-tenancy-in-the-metal-api" title="Permalink"></a></h2><h3 id="Not-every-adopter-will-be-interested-in-the-cloud-api"><a class="docs-heading-anchor" href="#Not-every-adopter-will-be-interested-in-the-cloud-api">Not every adopter will be interested in the cloud-api</a><a id="Not-every-adopter-will-be-interested-in-the-cloud-api-1"></a><a class="docs-heading-anchor-permalink" href="#Not-every-adopter-will-be-interested-in-the-cloud-api" title="Permalink"></a></h3><p>For example, users who want to combine the Metal Stack with Gardener, may not want to hide all of the Gardener&#39;s functionality behind the cloud-api in the way we do. They want to use the much more powerful Gardener Dashboard instead. The Gardener itself does not need the cloud-api either. It is a cluster-api by itself. It only needs to utilize our &quot;low-level API&quot; and actually expects this API to have multi-tenancy as otherwise every logged in user can create / destroy clusters in every existing project from the Gardener dashboard.</p><p>This makes obvious that, with our decision, we placed an unnecessary obstacle in the way of our adopters: They now need to implement an own layer between the Gardener and the metal-api to provide multi-tenancy. From the Gardener-perspective we strongly differ from other cloud providers in this aspect and it is a matter of time when this will become an issue. When we encourage adopters to implement such interfaces on their own we also partly lose control of our product, we increase divergence.</p><h3 id="We-cannot-claim-that-Metal-Stack-is-a-multi-tenant-solution-on-our-website"><a class="docs-heading-anchor" href="#We-cannot-claim-that-Metal-Stack-is-a-multi-tenant-solution-on-our-website">We cannot claim that Metal Stack is a multi-tenant solution on our website</a><a id="We-cannot-claim-that-Metal-Stack-is-a-multi-tenant-solution-on-our-website-1"></a><a class="docs-heading-anchor-permalink" href="#We-cannot-claim-that-Metal-Stack-is-a-multi-tenant-solution-on-our-website" title="Permalink"></a></h3><p>As the cloud-api is not part of the Metal Stack, the promise of multi-tenancy is only true for our network layer. Without the cloud-api to enable multi-tenancy, the network isolation is currently useless for end-users. Users of the Metal Stack can not self-manage machines, networks and ips without compromising the environment and thus, there is no self-service. We lose a valuable selling point when adopters can not immediately make use of our leading edge network isolation where we put so much effort to.</p><h3 id="Open-partitions-for-third-party-usage"><a class="docs-heading-anchor" href="#Open-partitions-for-third-party-usage">Open partitions for third-party usage</a><a id="Open-partitions-for-third-party-usage-1"></a><a class="docs-heading-anchor-permalink" href="#Open-partitions-for-third-party-usage" title="Permalink"></a></h3><p>If a third-party uses Gardener and our metal-api had multi-tenancy, we would be able to allow a third-party to create clusters with workers in our own partitions. At the moment, this is not possible because the Gardener needs to know the HMAC secrets to create worker nodes, which would compromise our environment. If a thirdy-party knows our HMAC we lose control over the machines of our own tenants.</p><h3 id="We-do-not-actually-want-to-open-source-the-cloud-api"><a class="docs-heading-anchor" href="#We-do-not-actually-want-to-open-source-the-cloud-api">We do not actually want to open-source the cloud-api</a><a id="We-do-not-actually-want-to-open-source-the-cloud-api-1"></a><a class="docs-heading-anchor-permalink" href="#We-do-not-actually-want-to-open-source-the-cloud-api" title="Permalink"></a></h3><p>One could think about solving the multi-tenancy issue by adding machine endpoints to the cloud-api. Gardener would then not consume the metal-api anymore but only the cloud-api.</p><p>This approach would not be ideal. We only want to offer a minimum viable product to adopters. The Gardener does not need a cluster-api as provided by the cloud-api. We want to treat additions on top of the basic stack as enterprise products.</p><p>The cloud-api contains billing endpoints, which are a perfect example for an optional addition of the Metal Stack. For basic usage of the Metal Stack a user does not need billing. Still, billing functionality can be interesting for some enterprises, who are like us, selling the infrastructure to third-parties.</p><h3 id="Increased-security-for-provider-admins"><a class="docs-heading-anchor" href="#Increased-security-for-provider-admins">Increased security for provider admins</a><a id="Increased-security-for-provider-admins-1"></a><a class="docs-heading-anchor-permalink" href="#Increased-security-for-provider-admins" title="Permalink"></a></h3><p>Multi-tenancy in the metal-api also has the potential to limit the damage that a provider administrator can cause by mistake. If an administrator has to acquire project permissions on machine-level we can effectively reduce the damage he can make to this single project.</p><p>Another example would be the automatic provisioning of a Gitlab CI runner used for integration testing (a use case that we have where we do not require the cloud-api). This can easily be done in automated manner with Ansible and the Metal dynamic inventory + modules. However, with Ansible, mistakes in the automation can be made very quickly and if Ansible would only see machines of a dedicated project, this would also reduce damage it can make.</p><p>It is likely that there are more similar use-cases like that to come (maybe even for the storage solution?).</p><p>Also the surface for our Gardener components (metal-ccm, gardener-extension-provider-metal, machine-controller-manager) would be reduced to project scopes.</p><h2 id="Conclusion"><a class="docs-heading-anchor" href="#Conclusion">Conclusion</a><a id="Conclusion-1"></a><a class="docs-heading-anchor-permalink" href="#Conclusion" title="Permalink"></a></h2><p>For these reasons the decision we made is very likely to have a negative impact on the adoption-rate of the Metal Stack and we should think about treating machines, networks and ips as first-class citizens as well. This makes us closer to the offer of hyperscalers. As mentioned in the beginning, all the time we tried to keep the possibility open to just offer bare metal machines. Let&#39;s continue with decision by adding multi-tenancy to the metal-api.</p><h2 id="Required-actions"><a class="docs-heading-anchor" href="#Required-actions">Required actions</a><a id="Required-actions-1"></a><a class="docs-heading-anchor-permalink" href="#Required-actions" title="Permalink"></a></h2><h3 id="Resource-scoping"><a class="docs-heading-anchor" href="#Resource-scoping">Resource scoping</a><a id="Resource-scoping-1"></a><a class="docs-heading-anchor-permalink" href="#Resource-scoping" title="Permalink"></a></h3><p>Just as implemented by the cloud-api, resource scoping needs to be added to almost every endpoint of the metal-api:</p><ul><li>Machines / Firewalls<ul><li>A user should only be able to view machines / firewalls of the projects he has at least view access to</li><li>A user should only be able to create and destroy machines / firewalls for projects he has at least editor access to Provider-tenants with at least view access can additionally view machines which have no project assignments Provider-tenants with at least editor access can additionally allocate / reserve machines which have no project assignments</li></ul></li><li>Networks<ul><li>A user should only be able to view networks of the projects he has at least view access to</li><li>A user should only be able to allocate networks of projects he has at least editor access to</li><li>A user should only be able to free networks assigned to projects he has at least editor access to Provider-tenants with at least view access can additionally view networks which have no project assignments Provider-tenants with at least editor access can additionally edit networks which have no project assignments Provider-tenants with at least admin access can additionally create or remove networks which have no project assignments</li></ul></li><li>IPs<ul><li>A user should only be able to view ips of the projects he has at least view access to</li><li>A user should only be able to allocate ips in networks of projects he has at least editor access to</li><li>A user should only be able to free ips assigned to projects he has at least editor access to</li></ul></li><li>Projects<ul><li>A logged in user is able to create projects when he has the permission to create projects</li><li>A user should only be able to view projects where he has at least view access to</li><li>A user should only be able to delete projects where he has admin access to</li></ul></li><li>Partitions / Images<ul><li>Only provider-admin users can add, delete, update</li><li>All logged in users can view</li></ul></li><li>IPMI<ul><li>Only provider-tenants can view machine IPMI data</li></ul></li><li>Endpoints for internal use<ul><li>Should only be accessible with HMAC auth and the HMAC secrets are only known by components of the Metal Stack (mainly for communication between partition and control plane), never for third-party usage</li></ul></li></ul><p>For all of this we need enhance the database queries with a filter for projects that a user has access to. As we already use a client to the masterdata-api in the metal-api, we can extract project memberships of a logged in user from there.</p><h3 id="More-permissions"><a class="docs-heading-anchor" href="#More-permissions">More permissions</a><a id="More-permissions-1"></a><a class="docs-heading-anchor-permalink" href="#More-permissions" title="Permalink"></a></h3><p>We do not only need <code>kaas-...</code> permissions in the LDAP but also <code>maas-</code>. This way we can differentiate between permissions for the cloud-api and permissions for the metal-api.</p><h3 id="Service-account-tokens-/-technical-users"><a class="docs-heading-anchor" href="#Service-account-tokens-/-technical-users">Service account tokens / technical users</a><a id="Service-account-tokens-/-technical-users-1"></a><a class="docs-heading-anchor-permalink" href="#Service-account-tokens-/-technical-users" title="Permalink"></a></h3><p>We need to provide the possibility for users to obtain access tokens to use for technical purposes (CI, third-party tooling like Gardener, ...).</p><p>We do not have this functionality yet, but it would also become a necessity for the cloud-api at some point in the future.</p><h3 id="Cloud-API"><a class="docs-heading-anchor" href="#Cloud-API">Cloud API</a><a id="Cloud-API-1"></a><a class="docs-heading-anchor-permalink" href="#Cloud-API" title="Permalink"></a></h3><ul><li>Project creation and deletion again have to be moved back into the metal-api, this also frees adopters from the need to write an own API in order to manage projects- The cloud-api will (again) only proxy project endpoints through to the metal-api</li><li>Do not point the secret bindings to a the shared provider secret in a partition. Create an individual provider-secret for the logged in tenant. The Gardener needs to use this tenant-specific provider secret to talk to the metal-api, do not give the Gardener HMAC access anymore.</li><li>The provider secret partition mapping can be removed from the cloud-api config and from the deployment</li></ul></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.10 on <span class="colophon-date" title="Tuesday 3 May 2022 08:44">Tuesday 3 May 2022</span>. Using Julia version 1.6.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
