<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Multi-Tenancy for the metal-api · metal-stack</title><meta name="title" content="Multi-Tenancy for the metal-api · metal-stack"/><meta property="og:title" content="Multi-Tenancy for the metal-api · metal-stack"/><meta property="twitter:title" content="Multi-Tenancy for the metal-api · metal-stack"/><meta name="description" content="Documentation for metal-stack."/><meta property="og:description" content="Documentation for metal-stack."/><meta property="twitter:description" content="Documentation for metal-stack."/><meta property="og:url" content="https://docs.metal-stack.io/development/proposals/MEP4/README/"/><meta property="twitter:url" content="https://docs.metal-stack.io/development/proposals/MEP4/README/"/><link rel="canonical" href="https://docs.metal-stack.io/development/proposals/MEP4/README/"/><script data-outdated-warner src="../../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../search_index.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script><link href="../../../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../../../assets/youtube.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="metal-stack logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../../">metal-stack</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Introduction</a></li><li><span class="tocitem">Overview</span><ul><li><a class="tocitem" href="../../../../overview/architecture/">Architecture</a></li><li><a class="tocitem" href="../../../../overview/networking/">Networking</a></li><li><a class="tocitem" href="../../../../overview/hardware/">Hardware Support</a></li><li><a class="tocitem" href="../../../../overview/os/">Operating Systems</a></li><li><a class="tocitem" href="../../../../overview/kubernetes/">Kubernetes Integration</a></li><li><a class="tocitem" href="../../../../overview/isolated-kubernetes/">Isolated Kubernetes</a></li><li><a class="tocitem" href="../../../../overview/gpu-support/">GPU Support</a></li><li><a class="tocitem" href="../../../../overview/storage/">Storage</a></li><li><a class="tocitem" href="../../../../overview/comparison/">Comparison</a></li></ul></li><li><a class="tocitem" href="../../../../quickstart/">Quickstart</a></li><li><span class="tocitem">Installation &amp; Administration</span><ul><li><a class="tocitem" href="../../../../installation/deployment/">Installation</a></li><li><a class="tocitem" href="../../../../installation/updates/">Releases and Updates</a></li><li><a class="tocitem" href="../../../../installation/monitoring/">Monitoring</a></li><li><a class="tocitem" href="../../../../installation/troubleshoot/">Troubleshoot</a></li></ul></li><li><span class="tocitem">User Guides</span><ul><li><a class="tocitem" href="../../../../external/mini-lab/README/">mini-lab</a></li><li><a class="tocitem" href="../../../../external/metalctl/README/">metalctl</a></li><li><a class="tocitem" href="../../../../external/csi-driver-lvm/README/">csi-driver-lvm</a></li><li><a class="tocitem" href="../../../../external/firewall-controller/README/">firewall-controller</a></li></ul></li><li><a class="tocitem" href="../../../../apidocs/apidocs/">API Documentation</a></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../../../client_libraries/">Client Libraries</a></li><li><a class="tocitem" href="../../../roadmap/">Roadmap</a></li><li><a class="tocitem" href="../../">Enhancement Proposals</a></li><li><a class="tocitem" href="../../../contributing/">Contributing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Multi-Tenancy for the metal-api</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Multi-Tenancy for the metal-api</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/metal-stack/docs.git" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="github.com/metal-stack/docs.git" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Multi-Tenancy-for-the-metal-api"><a class="docs-heading-anchor" href="#Multi-Tenancy-for-the-metal-api">Multi-Tenancy for the metal-api</a><a id="Multi-Tenancy-for-the-metal-api-1"></a><a class="docs-heading-anchor-permalink" href="#Multi-Tenancy-for-the-metal-api" title="Permalink"></a></h1><div class="admonition is-info"><header class="admonition-header">Info</header><div class="admonition-body"><p>This document is work in progress.</p></div></div><p>In the past we decided to treat the metal-api as a &quot;low-level API&quot;, i.e. the API does not specifically deal with projects and tenants. A user with editor access can for example assign machines to every project he desires, he can see all the machines available and can control them. We tried to keep the metal-api code base as small as possible and we added resource scoping to a &quot;higher-level APIs&quot;. From there, a user would be able to only see his own clusters and IP addresses.</p><p>As time passed metal-stack has become an open-source project and people are willing to adopt. Adopters who want to put their own technologies on top of the metal-stack infrastructure don&#39;t have those &quot;higher-level APIs&quot; that we implemented closed-source for our user base. So, external adopters most likely need to implement resource scoping on their own.</p><p>Introducing multi-tenancy to the metal-api is a serious chance of making our product better and more successful as it opens the door for:</p><ul><li>Becoming a &quot;fully-featured&quot; API</li><li>Narrowing down attack surfaces and possibility of unintended resource modification produced by bugs or human errors</li><li>Discouraging people to implement their own scoping layers in front of the metal-stack</li><li>Gaining performance through resource scopes</li><li>Letting untrusted / third-parties work with the API</li></ul><h2 id="Table-of-Contents"><a class="docs-heading-anchor" href="#Table-of-Contents">Table of Contents</a><a id="Table-of-Contents-1"></a><a class="docs-heading-anchor-permalink" href="#Table-of-Contents" title="Permalink"></a></h2><ul><li><a href="#Multi-Tenancy-for-the-metal-api">Multi-Tenancy for the metal-api</a></li><li class="no-marker"><ul><li><a href="#Table-of-Contents">Table of Contents</a></li><li><a href="#Requirements">Requirements</a></li><li><a href="#Implementation">Implementation</a></li><li class="no-marker"><ul><li><a href="#API-Definitions">API Definitions</a></li><li><a href="#API">API</a></li><li><a href="#API-Server">API Server</a></li><li><a href="#Migration-of-the-Consumers">Migration of the Consumers</a></li></ul></li><li><a href="#User-Scenarios">User Scenarios</a></li><li class="no-marker"><ul><li><a href="#Machine-Creation">Machine Creation</a></li><li><a href="#Scopes-for-Resources">Scopes for Resources</a></li></ul></li></ul></li></ul><h2 id="Requirements"><a class="docs-heading-anchor" href="#Requirements">Requirements</a><a id="Requirements-1"></a><a class="docs-heading-anchor-permalink" href="#Requirements" title="Permalink"></a></h2><p>These are some general requirements / higher objectives that MEP-4 has to fulfill.</p><ul><li>Should be able to run with mini-lab without requiring to setup complex auth backends (dex, LDAP, keycloak, ...)<ul><li>Simple to start with, more complex options for production setups</li></ul></li><li>Should utilize auth mechanisms that we have already in place to best possible degree</li><li>Fine-grained access permissions (every endpoint maps to a permission)</li><li>Tenant scoping (disallow resource access to resources of other tenants)</li><li>Project scoping (disallow resource access to resources of other projects)</li><li>Access tokens in self-service for technical user access</li></ul><h2 id="Implementation"><a class="docs-heading-anchor" href="#Implementation">Implementation</a><a id="Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation" title="Permalink"></a></h2><p>We gathered a lot of knowledge while implementing a multi-tenancy-capable backend for metalstack.cloud. The goal is now to use the same technology and adopt that to the metal-api, this includes:</p><ul><li>gRPC in combination with connectrpc</li><li>OPA for making auth decisions</li><li>REST HTTP only for OIDC login flows</li></ul><h3 id="API-Definitions"><a class="docs-heading-anchor" href="#API-Definitions">API Definitions</a><a id="API-Definitions-1"></a><a class="docs-heading-anchor-permalink" href="#API-Definitions" title="Permalink"></a></h3><p>The API definitions should be located on a separate Github repository separate from the server implementation. The proposed repository location is: https://github.com/metal-stack/api.</p><p>This repository contains the <code>proto3</code> specification of the exposed metal-stack api. This includes the messages, simple validations, services and the access permission to these services. The input parameters for the authorization in the backend are generated from the <code>proto3</code> annotations.</p><p>Client implementations for the most relevant languages (go, python) are generated automatically.</p><p>This api is divided into end-user and admin access at the top level. The proposed APIs are:</p><ul><li><code>api.v2</code>: For end-user facing services</li><li><code>admin.v2</code>: For operators and controllers which need access to unscoped entities</li></ul><p>The methods of the API can have different role scopes (and can be narrowed down further with fine-grained method permissions):</p><ul><li><code>tenant</code>: Tenant-scoped methods, e.g. project creation (tenant needs to be provided in the request payload)<ul><li>Available roles: VIEWER, EDITOR, OWNER</li></ul></li><li><code>project</code>: Project-scoped methods, e.g. machine creation (tenant needs to be provided in the request payload)<ul><li>Available roles: VIEWER, EDITOR, OWNER</li></ul></li><li><code>admin</code> Admin-scoped methods, e.g. unscoped tenant list or switch register<ul><li>Available roles: VIEWER, EDITOR</li></ul></li></ul><p>And has methods with different visibility scopes:</p><ul><li><code>self</code>: Methods that only the logged in user can access, e.g. show permissions with the presented token</li><li><code>public</code>: Methods that do not require any specific authorization</li><li><code>private</code>: Methods that are not exposed</li></ul><h3 id="API"><a class="docs-heading-anchor" href="#API">API</a><a id="API-1"></a><a class="docs-heading-anchor-permalink" href="#API" title="Permalink"></a></h3><p>The API server implements the services defined in the API and validates access to a method using OPA with the JWT tokens passed in the requests. The server is implemented using the connectrpc.com framework.</p><p>The API server implements the login flow through OIDC. After successful authentication, the API server derives user permissions from the OIDC provider and issues a new JWT token which is passed on to the user. The tokens including the permissions are stored in a redis compatible backend.</p><p>With these tokens, users can create Access Tokens for CI/CD or other use cases.</p><p>JWT Tokens can be revoked by admins and the user itself.</p><h3 id="API-Server"><a class="docs-heading-anchor" href="#API-Server">API Server</a><a id="API-Server-1"></a><a class="docs-heading-anchor-permalink" href="#API-Server" title="Permalink"></a></h3><p>Is put into a new github repo which implements the services defined in the <code>api</code> repository. It opens a <code>https</code> endpoints where the grpc (via connectrpc.com) and oidc servives are exposed.</p><h3 id="Migration-of-the-Consumers"><a class="docs-heading-anchor" href="#Migration-of-the-Consumers">Migration of the Consumers</a><a id="Migration-of-the-Consumers-1"></a><a class="docs-heading-anchor-permalink" href="#Migration-of-the-Consumers" title="Permalink"></a></h3><p>To allow consumers to migrate to the <code>v2</code> API gradually, both apis, the new and the old, are deployed in parallel. In the control-plane both apis are deployed side-by-side behind the ingress. <code>api.example.com</code> is forwarded to <code>metal-api</code> and <code>metal.example.com</code> is forwarded to the new <code>api-server</code>.</p><p>The api-server will talk to the existing metal-api during the process of migration services away to the new grpc api.</p><p>The migration process can be done in the following manner:</p><p>for each resource in the metal-api:</p><ul><li>create a new proto3 based definition in the <code>api</code> repo.</li><li>implement at least a small wrapper service in the <code>api-server</code> which asks the metal-api for this resource an maps the response back the caller in the grpc format.</li><li>identify all consumers of this resource and replace them to use the grpc instead of the rest api</li><li>move the business logic incl. the backend calls to ipam, metal-db, masterdata-ap, nsq for this resource from the metal-api to the api-server</li></ul><p>We will try to migrate the rethinkdb backend implementation to a generic approach during this effort.</p><p>There are a lot of consumers of metal-api, which need to be migrated:</p><ul><li>ansible</li><li>firewall-controller</li><li>firewall-controller-manager</li><li>gardener-extension-auth</li><li>gardener-extension-provider-metal<ul><li>Do not point the secret bindings to a the shared provider secret in the seed anymore. Instead, use individual provider-secret containing project-scoped API access tokens in the Gardener project namespaces.</li></ul></li><li>machine-controller-manager-provider-metal</li><li>metal-ccm</li><li>metal-console</li><li>metal-bmc</li><li>metal-core</li><li>metal-hammer</li><li>metal-image-cache-sync</li><li>metal-images</li><li>metal-metrics-exporter</li><li>metal-networker</li><li>metalctl</li><li>pixie</li></ul><h2 id="User-Scenarios"><a class="docs-heading-anchor" href="#User-Scenarios">User Scenarios</a><a id="User-Scenarios-1"></a><a class="docs-heading-anchor-permalink" href="#User-Scenarios" title="Permalink"></a></h2><p>This section gathers a collection of workflows from the perspective of a user that we want to provide with the implementation of this proposal.</p><h3 id="Machine-Creation"><a class="docs-heading-anchor" href="#Machine-Creation">Machine Creation</a><a id="Machine-Creation-1"></a><a class="docs-heading-anchor-permalink" href="#Machine-Creation" title="Permalink"></a></h3><p>A regular user wants to create a machine resource.</p><p>Requirements: Project was created, permissions are present</p><ul><li><p>The user can see networks that were provided by the admin.</p><pre><code class="nohighlight hljs">$ metalctl network ls
ID                                      NAME                     PROJECT     PARTITION       NAT     SHARED  PREFIXES         IPS
internet                                Internet Network                                     true    false   212.34.83.0/27    ●
tenant-super-network-fra-equ01          Project Super Network                fra-equ01       false   false   10.128.0.0/14     ●
underlay-fra-equ01                      Underlay Network                     fra-equ01       false   false   10.0.0.0/16       ●</code></pre></li><li><p>The user has to set the project scope first or provide <code>--project</code> flags for all commands.</p><pre><code class="nohighlight hljs">$ metalctl project set 793bb6cd-8b46-479d-9209-0fedca428fe1
You are now acting on project 793bb6cd-8b46-479d-9209-0fedca428fe1.</code></pre></li><li><p>The user can create the child network required for machine allocation.</p><pre><code class="nohighlight hljs">$ metalctl network allocate --partition fra-equ01 --name test</code></pre></li><li><p>Now, the user sees his own child network.</p><pre><code class="nohighlight hljs">$ metalctl network ls
ID                                      NAME                    PROJECT                                 PARTITION       NAT     SHARED  PREFIXES         IPS
internet                                Internet Network                                                                true    false   212.34.83.0/27    ●
tenant-super-network-fra-equ01          Project Super Network                                           fra-equ01       false   false   10.128.0.0/14     ●
└─╴08b9114b-ec47-4697-b402-a11421788dc6 test                    793bb6cd-8b46-479d-9209-0fedca428fe1    fra-equ01       false   false   10.128.64.0/22    ●
underlay-fra-equ01                      Underlay Network                                                fra-equ01       false   false   10.0.0.0/16       ●</code></pre></li><li><p>The user does not see any machines yet.</p><pre><code class="nohighlight hljs">$ metalctl machine ls</code></pre></li><li><p>The user can create a machine.</p><pre><code class="nohighlight hljs">$ metalctl machine create --networks internet,08b9114b-ec47-4697-b402-a11421788dc6 --name test --hostname test --image ubuntu-20.04 --partition fra-equ01 --size c1-xlarge-x86`</code></pre></li><li><p>The machine will now be provisioned.</p><pre><code class="nohighlight hljs">$ metalctl machine ls
ID                                     LAST EVENT      WHEN    AGE      HOSTNAME   PROJECT                                 SIZE            IMAGE                   PARTITION
00000000-0000-0000-0000-ac1f6b7befb2   Phoned Home     20s     50d 4h   test       793bb6cd-8b46-479d-9209-0fedca428fe1    c1-xlarge-x86   Ubuntu 20.04 20210415   fra-equ01</code></pre></li></ul><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>A user <strong>cannot</strong> list all allocated machines for all projects. The user <strong>must</strong> always switch project context first and can only view the machines inside this project. Only admins can see all machines at once.</p></div></div><h3 id="Scopes-for-Resources"><a class="docs-heading-anchor" href="#Scopes-for-Resources">Scopes for Resources</a><a id="Scopes-for-Resources-1"></a><a class="docs-heading-anchor-permalink" href="#Scopes-for-Resources" title="Permalink"></a></h3><p>The admins / operators of the metal-stack should be able to provide <em>global</em> resources that users are able to use along with their own resources. In particular, users can view and use <em>global</em> resources, but they are not allowed to create, modify or delete them.</p><div class="admonition is-info"><header class="admonition-header">Info</header><div class="admonition-body"><p>When a project ID field is empty on a resource, the resource is considered <em>global</em>.</p></div></div><p>Where possible, users should be capable of creating their own resource entities.</p><table><tr><th style="text-align: left">Resource</th><th style="text-align: left">User</th><th style="text-align: left">Global</th></tr><tr><td style="text-align: left">File System Layout</td><td style="text-align: left">yes</td><td style="text-align: left">yes</td></tr><tr><td style="text-align: left">Firewall</td><td style="text-align: left">yes</td><td style="text-align: left"></td></tr><tr><td style="text-align: left">Firmware</td><td style="text-align: left"></td><td style="text-align: left">yes</td></tr><tr><td style="text-align: left">OS Image</td><td style="text-align: left"></td><td style="text-align: left">yes</td></tr><tr><td style="text-align: left">Machine</td><td style="text-align: left">yes</td><td style="text-align: left"></td></tr><tr><td style="text-align: left">Network (Base)</td><td style="text-align: left"></td><td style="text-align: left">yes</td></tr><tr><td style="text-align: left">Network (Children)</td><td style="text-align: left">yes</td><td style="text-align: left"></td></tr><tr><td style="text-align: left">IP</td><td style="text-align: left">yes</td><td style="text-align: left"></td></tr><tr><td style="text-align: left">Partition</td><td style="text-align: left"></td><td style="text-align: left">yes</td></tr><tr><td style="text-align: left">Project</td><td style="text-align: left">yes</td><td style="text-align: left"></td></tr><tr><td style="text-align: left">Project Token</td><td style="text-align: left">yes</td><td style="text-align: left"></td></tr><tr><td style="text-align: left">Size</td><td style="text-align: left"></td><td style="text-align: left">yes</td></tr><tr><td style="text-align: left">Switch</td><td style="text-align: left"></td><td style="text-align: left"></td></tr><tr><td style="text-align: left">Tenant</td><td style="text-align: left"></td><td style="text-align: left">yes</td></tr></table><div class="admonition is-info"><header class="admonition-header">Info</header><div class="admonition-body"><p>Example: A user can make use of the file system layouts provided by the admins, but can also create own layouts. Same applies for images. As soon as a user creates own resources, the user takes over the responsibility for the machine provisioning to succeed.</p></div></div></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Wednesday 7 August 2024 09:08">Wednesday 7 August 2024</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
