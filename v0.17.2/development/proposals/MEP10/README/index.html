<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>SONiC Support · metal-stack</title><script data-outdated-warner src="../../../../assets/warner.js"></script><link rel="canonical" href="https://docs.metal-stack.io/development/proposals/MEP10/README/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script><link href="../../../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../../../assets/youtube.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="metal-stack logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../../">metal-stack</a></span></div><form class="docs-search" action="../../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Introduction</a></li><li><span class="tocitem">Overview</span><ul><li><a class="tocitem" href="../../../../overview/architecture/">Architecture</a></li><li><a class="tocitem" href="../../../../overview/networking/">Networking</a></li><li><a class="tocitem" href="../../../../overview/hardware/">Hardware Support</a></li><li><a class="tocitem" href="../../../../overview/os/">Operating Systems</a></li><li><a class="tocitem" href="../../../../overview/kubernetes/">Kubernetes Integration</a></li><li><a class="tocitem" href="../../../../overview/isolated-kubernetes/">Isolated Kubernetes</a></li><li><a class="tocitem" href="../../../../overview/storage/">Storage</a></li><li><a class="tocitem" href="../../../../overview/comparison/">Comparison</a></li></ul></li><li><a class="tocitem" href="../../../../quickstart/">Quickstart</a></li><li><span class="tocitem">Installation &amp; Administration</span><ul><li><a class="tocitem" href="../../../../installation/deployment/">Installation</a></li><li><a class="tocitem" href="../../../../installation/monitoring/">Monitoring</a></li><li><a class="tocitem" href="../../../../installation/troubleshoot/">Troubleshoot</a></li></ul></li><li><span class="tocitem">User Guides</span><ul><li><a class="tocitem" href="../../../../external/mini-lab/README/">mini-lab</a></li><li><a class="tocitem" href="../../../../external/metalctl/README/">metalctl</a></li><li><a class="tocitem" href="../../../../external/csi-driver-lvm/README/">csi-driver-lvm</a></li><li><a class="tocitem" href="../../../../external/firewall-controller/README/">firewall-controller</a></li></ul></li><li><a class="tocitem" href="../../../../apidocs/apidocs/">API Documentation</a></li><li><span class="tocitem">Development</span><ul><li><a class="tocitem" href="../../../client_libraries/">Client Libraries</a></li><li><a class="tocitem" href="../../../roadmap/">Roadmap</a></li><li><a class="tocitem" href="../../">Enhancement Proposals</a></li><li><a class="tocitem" href="../../../contributing/">Contributing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>SONiC Support</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>SONiC Support</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="github.com/metal-stack/docs.git" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="SONiC-Support"><a class="docs-heading-anchor" href="#SONiC-Support">SONiC Support</a><a id="SONiC-Support-1"></a><a class="docs-heading-anchor-permalink" href="#SONiC-Support" title="Permalink"></a></h1><p>As writing this proposal, metal-stack only supports Cumulus on Broadcom ASICs. Unfortunately, after the acquisition of Cumulus Networks by Nvidia, Broadcom decided to cut its relationship with Cumulus, and therefore Cumulus 4.2 is the last version that supports Broadcom ASICs. Since trashing the existing hardware is not a solution, adding support for a different network operating system is necessary.</p><p>One of the remaining big players is <a href="https://sonic-net.github.io/SONiC/">SONiC</a>, which Microsoft created to scale the network of Azure. It&#39;s an open-source project and is now part of the <a href="https://www.linuxfoundation.org/press/press-release/software-for-open-networking-in-the-cloud-sonic-moves-to-the-linux-foundation">Linux Foundation</a>.</p><p>For a general introduction to SONiC, please follow the <a href="https://github.com/sonic-net/SONiC/wiki/Architecture">Architecture</a> official documentation.</p><h2 id="ConfigDB"><a class="docs-heading-anchor" href="#ConfigDB">ConfigDB</a><a id="ConfigDB-1"></a><a class="docs-heading-anchor-permalink" href="#ConfigDB" title="Permalink"></a></h2><p>On a cold start, the content of <code>/etc/sonic/config_db.json</code> will be loaded into the Redis database <code>CONFIG_DB</code>, and both contain the switch&#39;s configuration except the BGP unnumbered configuration, which still has to be configured directly by the frr configuration files. The SONiC community is working to remove this exception, but no release date is known.</p><h2 id="BGP-Configuration"><a class="docs-heading-anchor" href="#BGP-Configuration">BGP Configuration</a><a id="BGP-Configuration-1"></a><a class="docs-heading-anchor-permalink" href="#BGP-Configuration" title="Permalink"></a></h2><p>Frr runs inside a container, and a shell script configured it on the container startup. For BGP unnumbered, we must set the configuration variable <code>docker_routing_config_mode</code> to <code>split</code> to prevent SONiC from overwriting our configuration files created by <code>metal-core</code>. But by using the split mode, the integrated configuration mode of frr is deactivated, and we have to write our BGP configuration to the daemon-specific files <code>bgp.conf</code>, <code>staticd.conf</code>, and <code>zebra.conf</code> instead to <code>frr.conf</code>.</p><pre><code class="language-shell hljs">elif [ &quot;$CONFIG_TYPE&quot; == &quot;split&quot; ]; then
    echo &quot;no service integrated-vtysh-config&quot; &gt; /etc/frr/vtysh.conf
    rm -f /etc/frr/frr.conf</code></pre><p>Reference: <a href="https://github.com/sonic-net/sonic-buildimage/blob/202205/dockers/docker-fpm-frr/docker_init.sh#L69">docker-init</a></p><p>Adding support for the integrated configuration mode, we must at least adjust the startup shell script and the supervisor configuration:</p><pre><code class="language-bash hljs">{% if DEVICE_METADATA.localhost.docker_routing_config_mode is defined and DEVICE_METADATA.localhost.docker_routing_config_mode == &quot;unified&quot; %}
[program:vtysh_b]
command=/usr/bin/vtysh -b</code></pre><p>Reference: <a href="https://github.com/sonic-net/sonic-buildimage/blob/202205/dockers/docker-fpm-frr/frr/supervisord/supervisord.conf.j2#L157">supervisord.conf</a></p><h2 id="Non-BGP-Configuration"><a class="docs-heading-anchor" href="#Non-BGP-Configuration">Non-BGP Configuration</a><a id="Non-BGP-Configuration-1"></a><a class="docs-heading-anchor-permalink" href="#Non-BGP-Configuration" title="Permalink"></a></h2><p>For the Non-BGP configuration we have to write it into the Redis database directly or via one of the following interfaces:</p><ul><li><code>config replace &lt;file&gt;</code></li><li>the Mgmt Framework</li><li>the SONiC restapi</li></ul><p>Directly writing into the Redis database isn&#39;t a stable interface, and we must determine the create, delete, and update operations on our own. The last point is also valid for the Mgmt Framework and the SONiC restapi. Furthermore, the Mgmt Framework doesn&#39;t start anymore for several months, and a <a href="https://github.com/sonic-net/sonic-buildimage/pull/10893">potential fix</a>  is still not merged. And the SONiC restapi isn&#39;t enabled by default, and we must build and maintain our own SONiC images.</p><p>Using <code>config replace</code> would reduce the complexity in the <code>metal-core</code> codebase because we don&#39;t have to determine the actual changes between the running and the desired configuration. The approach&#39;s drawbacks are using a version of SONiC that contains the PR <a href="https://github.com/sonic-net/sonic-buildimage/pull/7294">Yang support for VXLAN</a>, and we must provide the whole new startup configuration to prevent unwanted deconfiguration.</p><h3 id="Configure-Loopback-interface-and-activate-VXLAN"><a class="docs-heading-anchor" href="#Configure-Loopback-interface-and-activate-VXLAN">Configure Loopback interface and activate VXLAN</a><a id="Configure-Loopback-interface-and-activate-VXLAN-1"></a><a class="docs-heading-anchor-permalink" href="#Configure-Loopback-interface-and-activate-VXLAN" title="Permalink"></a></h3><pre><code class="language-json hljs">{
 &quot;LOOPBACK_INTERFACE&quot;: {
  &quot;Loopback0&quot;: {},
  &quot;Loopback0|&lt;loopback address/32&gt;&quot;: {}
 },
 &quot;VXLAN_TUNNEL&quot;: {
  &quot;vtep&quot;: {
   &quot;src_ip&quot;: &quot;&lt;loopback address&gt;&quot;
  }
 }
}</code></pre><h4 id="Configure-MTU"><a class="docs-heading-anchor" href="#Configure-MTU">Configure MTU</a><a id="Configure-MTU-1"></a><a class="docs-heading-anchor-permalink" href="#Configure-MTU" title="Permalink"></a></h4><pre><code class="language-json hljs">{
 &quot;PORT&quot;: {
  &quot;Ethernet0&quot;: {
   &quot;mtu&quot;: &quot;9000&quot;
  }
 }
}</code></pre><h4 id="Configure-PXE-Vlan"><a class="docs-heading-anchor" href="#Configure-PXE-Vlan">Configure PXE Vlan</a><a id="Configure-PXE-Vlan-1"></a><a class="docs-heading-anchor-permalink" href="#Configure-PXE-Vlan" title="Permalink"></a></h4><pre><code class="language-json hljs">{
 &quot;VLAN&quot;: {
  &quot;Vlan4000&quot;: {
   &quot;vlanid&quot;: &quot;4000&quot;
  }
 },
 &quot;VLAN_INTERFACE&quot;: {
  &quot;Vlan4000&quot;: {},
  &quot;Vlan4000|&lt;metal core cidr&gt;&quot;: {}
 },
 &quot;VLAN_MEMBER&quot;: {
  &quot;Vlan4000|&lt;interface&gt;&quot;: {
   &quot;tagging_mode&quot;: &quot;untagged&quot;
  }
 },
 &quot;VXLAN_TUNNEL_MAP&quot;: {
  &quot;vtep|map_104000_Vlan4000&quot;: {
   &quot;vlan&quot;: &quot;Vlan4000&quot;,
   &quot;vni&quot;: &quot;104000&quot;
  }
 }
}</code></pre><h4 id="Configure-VRF"><a class="docs-heading-anchor" href="#Configure-VRF">Configure VRF</a><a id="Configure-VRF-1"></a><a class="docs-heading-anchor-permalink" href="#Configure-VRF" title="Permalink"></a></h4><pre><code class="language-json hljs">{
 &quot;INTERFACE&quot;: {
  &quot;Ethernet0&quot;: {
   &quot;vrf_name&quot;: &quot;vrf104001&quot;
  }
 },
 &quot;VLAN&quot;: {
  &quot;Vlan4001&quot;: {
   &quot;vlanid&quot;: &quot;4001&quot;
  }
 },
 &quot;VLAN_INTERFACE&quot;: {
  &quot;Vlan4001&quot;: {
   &quot;vrf_name&quot;: &quot;vrf104001&quot;
  }
 },
 &quot;VRF&quot;: {
  &quot;vrf104001&quot;: {
   &quot;vni&quot;: &quot;104001&quot;
  }
 },
 &quot;VXLAN_TUNNEL_MAP&quot;: {
  &quot;vtep|map_104001_Vlan4001&quot;: {
   &quot;vlan&quot;: &quot;Vlan4001&quot;,
   &quot;vni&quot;: &quot;104001&quot;
  }
 }
}</code></pre><h2 id="DHCP-Relay"><a class="docs-heading-anchor" href="#DHCP-Relay">DHCP Relay</a><a id="DHCP-Relay-1"></a><a class="docs-heading-anchor-permalink" href="#DHCP-Relay" title="Permalink"></a></h2><p>The DHCP relay container only starts if <code>DEVICE_METADATA.localhost.type</code> is equal to <code>ToRRouter</code>.</p><h2 id="LLDP"><a class="docs-heading-anchor" href="#LLDP">LLDP</a><a id="LLDP-1"></a><a class="docs-heading-anchor-permalink" href="#LLDP" title="Permalink"></a></h2><p>SONiC always uses the local port subtype for LLDP and sets it to some freely configurable alias field of the interface.</p><pre><code class="language-python hljs"># Get the port alias. If None or empty string, use port name instead
port_alias = port_table_dict.get(&quot;alias&quot;)
if not port_alias:
    self.log_info(&quot;Unable to retrieve port alias for port &#39;{}&#39;. Using port name instead.&quot;.format(port_name))
    port_alias = port_name

lldpcli_cmd = &quot;lldpcli configure ports {0} lldp portidsubtype local {1}&quot;.format(port_name, port_alias)</code></pre><p>Reference: <a href="https://github.com/sonic-net/sonic-buildimage/blob/202205/dockers/docker-lldp/lldpmgrd#L153">lldpmgr</a></p><h2 id="Mgmt-Interface"><a class="docs-heading-anchor" href="#Mgmt-Interface">Mgmt Interface</a><a id="Mgmt-Interface-1"></a><a class="docs-heading-anchor-permalink" href="#Mgmt-Interface" title="Permalink"></a></h2><p>The mgmt interface is <code>eth0</code>. To configure a static IP address and activate the Mgmt VRF, use:</p><pre><code class="language-json hljs">{
 &quot;MGMT_INTERFACE&quot;: {
  &quot;eth0|&lt;mgmt cidr&gt;&quot;: {
   &quot;gwaddr&quot;: &quot;&lt;mgmt gateway&gt;&quot;
  }
 },
 &quot;MGMT_VRF_CONFIG&quot;: {
  &quot;vrf_global&quot;: {
   &quot;mgmtVrfEnabled&quot;: &quot;true&quot;
  }
 }
}</code></pre><p><a href="https://github.com/sonic-net/sonic-buildimage/blob/202205/files/image_config/sysctl/sysctl-net.conf#L7">IP forwarding is deactivated on <code>eth0</code></a>, and no IP Masquerade is configured.</p></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Monday 4 March 2024 10:59">Monday 4 March 2024</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
